/*! Canvace Client Library - v0.2.7 - 2013-04-16
* http://www.canvace.com/
* Copyright (c) 2013 Canvace Srl */
var Canvace=function(){"use strict";var e={};return typeof Array.prototype.forEach!="function"&&(Array.prototype.forEach=function(e,t){for(var n=0,r=this.length;n<r;++n)e.call(t,this[n],n,this)}),typeof Array.isArray!="function"&&(Array.isArray=function(e){return Object.prototype.toString.call(e)==="[object Array]"}),e.Polyfill=function(){var t=["webkit","moz","ms","o"],n=function(e,n){function i(e,t){return typeof t=="function"?function(){return t.apply(e,arguments)}:t}var r=n.charAt(0).toUpperCase()+n.substr(1);for(var s in t){var o=t[s]+r;if(o in e)return i(e,e[o])}return i(e,e[n])};return{vendorPrefixes:t,getPrefixedProperty:function(t,r){return arguments.length<2&&(r=t,t=window),Array.isArray(r)&&r.length>1?n(t,r.shift())||e.Polyfill.getPrefixedProperty(t,r):n(t,r.toString())}}}(),e.Timing={now:function(){if(!!window.performance){var t=e.Polyfill.getPrefixedProperty(window.performance,"now");if(!!t)return function(){return t.call(window.performance)}}return function(){return Date.now()}}()},e.MultiSet=function(){function r(r){var i=t++;return e[i]=r,n++,function(){return e.hasOwnProperty(i)?(delete e[i],n--,!0):!1}}var e={},t=0,n=0;(function(e){for(var t in e)r(e[t])})(arguments),this.add=r,this.forEach=function(t){var r=function(t){return function(){return e.hasOwnProperty(t)?(delete e[t],n--,!0):!1}};for(var i in e)if(e.hasOwnProperty(i)&&t(e[i],r(i))===!1)return!0;return!1},this.fastForEach=function(t){for(var n in e)e.hasOwnProperty(n)&&t(e[n])},this.count=function(){return n},this.isEmpty=function(){return!n},this.clear=function(){e={},n=0}},e.List=function(){function r(n){if(!n)return null;this.element=function(){return n.element},this.previous=function(){if("removed"in n)throw{message:"no previous element, this element has been removed",element:n.element};return new r(n.previous)},this.next=function(){if("removed"in n)throw{message:"no next element, this element has been removed",element:n.element};return new r(n.next)},this.remove=function(){return"removed"in n?!1:(n.previous&&(n.previous.next=n.next),n.next&&(n.next.previous=n.previous),n===e&&(e=n.next),n===t&&(t=n.previous),n.removed=!0,!0)}}var e=null,t=null,n=0;this.addHead=function(i){return e={element:i,previous:null,next:e},t||(t=e),n++,new r(e)},this.getHead=function(){return new r(e)},this.addTail=function(i){return t={element:i,previous:t,next:null},e||(e=t),n++,new r(t)},this.getTail=function(){return new r(t)},this.count=function(){return n},this.isEmpty=function(){return!n},this.clear=function(){e=null,t=null,n=0},this.forEach=function(t){for(var n=e;n;n=n.next)if(t(n.element)===!1)return!0;return!1},this.forEachReverse=function(e){for(var n=t;n;n=n.previous)if(e(n.element)===!1)return!0;return!1}},e.Heap=function(e,t){function r(e){return e*2+1}function i(e){return e*2+2}function s(e){return Math.floor((e-1)/2)}function o(t,r){return e(n[t],n[r])<0}function u(e,t){var r=n[e];n[e]=n[t],n[t]=r}function a(e){var t=r(e),s=i(e),f=e;n.length>t&&o(t,e)&&(f=t),n.length>s&&o(s,f)&&(f=s),f>e&&(u(e,f),a(f))}function f(s,o,u){return o<n.length?t(s,n[o])?(typeof u=="function"&&u(o),!0):e(s,n[o])<0?!1:f(s,r(o),u)||f(s,i(o),u):!1}t||(t=function(e,t){return e===t});var n=[];this.push=function(e){var t=n.length;n.push(e);var r=s(t);while(t&&o(t,r))u(t,r),t=r,r=s(t)},this.pop=function(){var e=n[0],t=n.pop();return n.length&&(n[0]=t,a(0)),e},this.peek=function(){if(n.length>0)return n[0]},this.contains=function(e){return f(e,0)},this.find=function(e){var t;if(f(e,0,function(e){t=n[e]}))return t},this.decreaseKey=function(e,t){return f(e,0,function(e){t(n[e]);var r=s(e);while(e&&o(e,r))u(e,r),e=r,r=s(e)})},this.count=function(){return n.length},this.isEmpty=function(){return!n.length},this.clear=function(){n=[]}},e.Ajax=new function(){function t(e){var t=this;typeof e.async=="undefined"&&(e.async=!0),typeof e.type=="undefined"&&(e.type=""),typeof e.user=="undefined"&&(e.user=""),typeof e.password=="undefined"&&(e.password="");var n=new XMLHttpRequest;n.addEventListener("load",function(){typeof e.load=="function"&&e.load.call(t,function(){switch(e.type){case"":case"text":return n.responseText;case"json":return JSON.parse(n.responseText);case"document":return n.responseXML;default:return n.response}}())},!1),n.addEventListener("error",function(){typeof e.error=="function"&&e.error.call(t,n.status,n.statusText)},!1),n.open(e.method,e.url,e.async,e.user,e.password),n.responseType=e.type==="json"?"text":e.type,n.send(),this.onLoad=function(n){return e.load=n,t},this.onError=function(n){return e.error=n,t}}function n(e,n){var r={method:e};if(n.length===1){if(typeof n[0]=="object")return n[0].method=e,new t(n[0])}else{if(n.length!==2)throw"wrong number of arguments";r.type=n[1]}return r.url=n[0],new t(r)}this.get=function(){return n("GET",arguments)},this.post=function(){return n("POST",arguments)},this.getJSON=function(t,n,r){return e.Ajax.get({url:t,type:"json",load:n,error:r})}},e.StateMachine=function(e,t){function s(t){if(!(t in e))throw'invalid state "'+t+'"';r=e[t],i=t}var n=function(){var t={};for(var n in e)if(e.hasOwnProperty(n))for(var r in e[n])e[n].hasOwnProperty(r)&&(t[r]=!0);return t}(),r,i;s(t),function(e){var t=function(e){return function(){if(e in r){if(typeof r[e]=="string"){var t=r[e];return s(t),t}if(typeof r[e]=="function"){var n=r[e].apply(r,arguments);return typeof n=="string"?(s(n),n):i}throw'invalid transition "'+e+'" for state "'+i+'"'}return i}};for(var o in n)n.hasOwnProperty(o)&&(e[o]=t(o))}(this),this.getCurrentState=function(){return i}},e.ParametricStateMachine=function(e,t,n){function s(e){if(typeof e!="string"){if(!(0 in e))throw"invalid transition: "+e;var n=e;e=e[0];if(!(e in t))throw'invalid state "'+e+'"';typeof t[e]!="function"?r=t[e]:(n.shift(),r=t[e].apply(r,n)),i=e}else{if(!(e in t))throw'invalid state "'+e+'"';typeof t[e]!="function"?r=t[e]:r=t[e].call(r),i=e}}var r,i;s(n),function(t){var n=function(e){t[e]=function(){if(e in r)if(typeof r[e]!="function")s(r[e]);else{var t=r[e].apply(r,arguments);typeof t!="undefined"&&s(t)}return i}};for(var o in e)n(e[o])}(this),this.getCurrentState=function(){return i}},e.Astar=function(t){if(typeof t!="number")t=0;else if(t<0)throw"the epsilon parameter must be positive";this.findPath=function(n){var r={},i={},s={},o=new e.Heap(function(e,n){var r=i[e.id]+e.heuristic*(1+t),s=i[n.id]+n.heuristic*(1+t);return r<s?-1:r>s?1:0},function(e,t){return e.id===t.id}),u;i[n.id]=0,o.push(n);while(!o.isEmpty()){var a=o.pop(),f=i[a.id];delete i[a.id];if(!a.heuristic){var h=[];for(u=a;s.hasOwnProperty(u.id);u=s[u.id].parent)h.push(s[u.id].edge);return h.reverse()}r[a.id]=!0;for(var l in a.neighbors)if(a.neighbors.hasOwnProperty(l)){u=a.neighbors[l]();if(!r.hasOwnProperty(u.id)){var c=f+a.distance(l);i.hasOwnProperty(u.id)?c<i[u.id]&&o.decreaseKey(u,function(e){i[e.id]=c,s[e.id]={parent:a,edge:l}}):(i[u.id]=c,s[u.id]={parent:a,edge:l},o.push(u))}}}return null}},e.mobileBrowser=function(e){return/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows (ce|phone)|xda|xiino|android|ipad|playbook|silk/i.test(e)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(e.substr(0,4))}(navigator.userAgent||navigator.vendor||window.opera),typeof window.KeyEvent=="undefined"&&(window.KeyEvent={DOM_VK_CANCEL:3,DOM_VK_HELP:6,DOM_VK_BACK_SPACE:8,DOM_VK_TAB:9,DOM_VK_CLEAR:12,DOM_VK_RETURN:13,DOM_VK_ENTER:14,DOM_VK_SHIFT:16,DOM_VK_CONTROL:17,DOM_VK_ALT:18,DOM_VK_PAUSE:19,DOM_VK_CAPS_LOCK:20,DOM_VK_KANA:21,DOM_VK_HANGUL:21,DOM_VK_EISU:22,DOM_VK_JUNJA:23,DOM_VK_FINAL:24,DOM_VK_HANJA:25,DOM_VK_KANJI:25,DOM_VK_ESCAPE:27,DOM_VK_CONVERT:28,DOM_VK_NONCONVERT:29,DOM_VK_ACCEPT:30,DOM_VK_MODECHANGE:31,DOM_VK_SPACE:32,DOM_VK_PAGE_UP:33,DOM_VK_PAGE_DOWN:34,DOM_VK_END:35,DOM_VK_HOME:36,DOM_VK_LEFT:37,DOM_VK_UP:38,DOM_VK_RIGHT:39,DOM_VK_DOWN:40,DOM_VK_SELECT:41,DOM_VK_PRINT:42,DOM_VK_EXECUTE:43,DOM_VK_PRINTSCREEN:44,DOM_VK_INSERT:45,DOM_VK_DELETE:46,DOM_VK_0:48,DOM_VK_1:49,DOM_VK_2:50,DOM_VK_3:51,DOM_VK_4:52,DOM_VK_5:53,DOM_VK_6:54,DOM_VK_7:55,DOM_VK_8:56,DOM_VK_9:57,DOM_VK_COLON:58,DOM_VK_SEMICOLON:59,DOM_VK_LESS_THAN:60,DOM_VK_EQUALS:61,DOM_VK_GREATER_THAN:62,DOM_VK_QUESTION_MARK:63,DOM_VK_AT:64,DOM_VK_A:65,DOM_VK_B:66,DOM_VK_C:67,DOM_VK_D:68,DOM_VK_E:69,DOM_VK_F:70,DOM_VK_G:71,DOM_VK_H:72,DOM_VK_I:73,DOM_VK_J:74,DOM_VK_K:75,DOM_VK_L:76,DOM_VK_M:77,DOM_VK_N:78,DOM_VK_O:79,DOM_VK_P:80,DOM_VK_Q:81,DOM_VK_R:82,DOM_VK_S:83,DOM_VK_T:84,DOM_VK_U:85,DOM_VK_V:86,DOM_VK_W:87,DOM_VK_X:88,DOM_VK_Y:89,DOM_VK_Z:90,DOM_VK_WIN:91,DOM_VK_CONTEXT_MENU:93,DOM_VK_SLEEP:95,DOM_VK_NUMPAD0:96,DOM_VK_NUMPAD1:97,DOM_VK_NUMPAD2:98,DOM_VK_NUMPAD3:99,DOM_VK_NUMPAD4:100,DOM_VK_NUMPAD5:101,DOM_VK_NUMPAD6:102,DOM_VK_NUMPAD7:103,DOM_VK_NUMPAD8:104,DOM_VK_NUMPAD9:105,DOM_VK_MULTIPLY:106,DOM_VK_ADD:107,DOM_VK_SEPARATOR:108,DOM_VK_SUBTRACT:109,DOM_VK_DECIMAL:110,DOM_VK_DIVIDE:111,DOM_VK_F1:112,DOM_VK_F2:113,DOM_VK_F3:114,DOM_VK_F4:115,DOM_VK_F5:116,DOM_VK_F6:117,DOM_VK_F7:118,DOM_VK_F8:119,DOM_VK_F9:120,DOM_VK_F10:121,DOM_VK_F11:122,DOM_VK_F12:123,DOM_VK_F13:124,DOM_VK_F14:125,DOM_VK_F15:126,DOM_VK_F16:127,DOM_VK_F17:128,DOM_VK_F18:129,DOM_VK_F19:130,DOM_VK_F20:131,DOM_VK_F21:132,DOM_VK_F22:133,DOM_VK_F23:134,DOM_VK_F24:135,DOM_VK_NUM_LOCK:144,DOM_VK_SCROLL_LOCK:145,DOM_VK_CIRCUMFLEX:160,DOM_VK_EXCLAMATION:161,DOM_VK_DOUBLE_QUOTE:162,DOM_VK_HASH:163,DOM_VK_DOLLAR:164,DOM_VK_PERCENT:165,DOM_VK_AMPERSAND:166,DOM_VK_UNDERSCORE:167,DOM_VK_OPEN_PAREN:168,DOM_VK_CLOSE_PAREN:169,DOM_VK_ASTERISK:170,DOM_VK_PLUS:171,DOM_VK_PIPE:172,DOM_VK_HYPHEN_MINUS:173,DOM_VK_OPEN_CURLY_BRACKET:174,DOM_VK_CLOSE_CURLY_BRACKET:175,DOM_VK_TILDE:176,DOM_VK_COMMA:188,DOM_VK_PERIOD:190,DOM_VK_SLASH:191,DOM_VK_BACK_QUOTE:192,DOM_VK_OPEN_BRACKET:219,DOM_VK_BACK_SLASH:220,DOM_VK_CLOSE_BRACKET:221,DOM_VK_QUOTE:222,DOM_VK_META:224,DOM_VK_ALTGR:225,DOM_KEY_LOCATION_STANDARD:0,DOM_KEY_LOCATION_LEFT:1,DOM_KEY_LOCATION_RIGHT:2,DOM_KEY_LOCATION_NUMPAD:3,DOM_KEY_LOCATION_MOBILE:4,DOM_KEY_LOCATION_JOYSTICK:5}),e.Keyboard=function(t,n){function r(){function n(n,r){return n in t||(t[n]=new e.MultiSet),t[n].add(r||function(){})}var t={};this.register=function(e,t){if(typeof e=="number")return n(e,t);var r=[];for(var i in e)r.push(n(e[i],t));return function(){for(var e in r)r[e]()}},this.fire=function(e){return e in t?(t[e].fastForEach(function(t){t(e)}),!0):!1}}var i={},s={},o=new r,u=new r,a=new r;n===!0||typeof n=="undefined"?(t.addEventListener("keydown",function(e){var t=e.charCode||e.keyCode;i[t]?s[t]&&e.preventDefault():(i[t]=!0,o.fire(t)&&(s[t]=!0,e.preventDefault()))},!1),t.addEventListener("keypress",function(e){a.fire(e.charCode||e.keyCode)&&e.preventDefault()},!1),t.addEventListener("keyup",function(e){var t=e.charCode||e.keyCode;delete i[t],delete s[t],u.fire(t)&&e.preventDefault()},!1)):(t.addEventListener("keydown",function(e){var t=e.charCode||e.keyCode;i[t]||(i[t]=!0,o.fire(t))},!1),t.addEventListener("keypress",function(e){a.fire(e.charCode||e.keyCode)},!1),t.addEventListener("keyup",function(e){var t=e.charCode||e.keyCode;delete i[t],u.fire(t)},!1)),this.isKeyDown=function(e){return e in i},this.areKeysDown=function(){for(var e in arguments)if(!i[arguments[e]])return!1;return!0},this.onKeyDown=o.register,this.onKeyUp=function(e,t){return typeof e!="number"?u.register(e,function(){for(var n in e)if(i[e[n]])return;return t.apply(this,arguments)}):u.register(e,t)},this.onKeyPress=a.register},e.Mouse=function(t){var n=new e.MultiSet,r=new e.MultiSet,i=new e.MultiSet,s=new e.MultiSet,o=new e.MultiSet,u=!1,a=0,f,l;t.addEventListener("mousedown",function(e){var n=e.clientX-t.offsetLeft,i=e.clientY-t.offsetTop;a=e.button,u=!0,f=n,l=i,r.fastForEach(function(t){t(n,i,e.button)})},!1),t.addEventListener("mousemove",function(e){var r=e.clientX-t.offsetLeft,i=e.clientY-t.offsetTop;n.fastForEach(function(e){e(r,i)}),u&&(s.fastForEach(function(e){e(f,l,r,i,a)}),f=r,l=i)},!1),t.addEventListener("mouseup",function(e){var n=e.clientX-t.offsetLeft,r=e.clientY-t.offsetTop;u=!1,i.fastForEach(function(t){t(n,r,e.button)})},!1),typeof t.onwheel!="undefined"?t.addEventListener("wheel",function(e){var n=e.clientX-t.offsetLeft,r=e.clientY-t.offsetTop;o.fastForEach(function(t){t(n,r,-e.deltaX,-e.deltaY)})},!1):typeof t.onmousewheel!="undefined"&&t.addEventListener("mousewheel",function(e){var n=e.clientX-t.offsetLeft,r=e.clientY-t.offsetTop;o.fastForEach(function(t){t(n,r,e.wheelDeltaX,e.wheelDeltaY)})},!1),this.onMove=function(e){return n.add(e)},this.onDown=function(e){return r.add(e)},this.onUp=function(e){return i.add(e)},this.onDrag=function(e){return s.add(e)},this.onWheel=function(e){return o.add(e)}},e.Loader=function(t){function d(){r((f+h)/p)}function v(){a&&c&&n(s)}function m(n){function p(e){return function(){l.hasOwnProperty(e)&&l[e].fastForEach(function(t){t.width=u[e].width,t.height=u[e].height}),c.hasOwnProperty(e)&&c[e].fastForEach(function(t){t.width=u[e].width,t.height=u[e].height}),h()}}function m(e){for(var n in e.frames)(function(e){if(e in u)p(e)();else{var n=new Image;u[e]=n,n.addEventListener("load",p(e),!1),n.src=[t.basePath,e].join("/")}})(e.frames[n].id)}var r=0,i,o,l={};for(i in n.tiles)n.tiles.hasOwnProperty(i)&&(o=n.tiles[i].frames,r+=o.length,o.length&&(l.hasOwnProperty(o[0].id)||(l[o[0].id]=new e.MultiSet),l[o[0].id].add(n.tiles[i])));var c={};for(i in n.entities)n.entities.hasOwnProperty(i)&&(o=n.entities[i].frames,r+=o.length,o.length&&(c.hasOwnProperty(o[0].id)||(c[o[0].id]=new e.MultiSet),c[o[0].id].add(n.entities[i])));var h=function(){var e=0;return function(){f=100*++e/Math.max(1,r),d(),e>=r&&(a=!0,v())}}();if(r===0)return h(),s;for(i in n.tiles)m(n.tiles[i]);for(i in n.entities)m(n.entities[i]);return s}function g(n){function a(e){return function(){i(e)}}function f(n){for(var r in n)try{var i=e.Loader.getSourceInfo(n[r]);if(o.canPlayType(i.mimeType))return[t.basePath,i.url].join("/")}catch(s){return!1}return!1}var r=Object.keys(n).length,u=function(){var e=0;return function(){h=100*++e/Math.max(1,r),d(),e>=r&&(c=!0,v())}}();if(r===0)return u(),s;for(var p in n)if(p in l)u();else{var m=f(n[p]);!1===m?(i(p),u()):l[p]=o.load(m,u,a(p))}return s}if(typeof t.basePath!="string")throw'Invalid value specified for "basePath"';if(typeof t.complete!="function")throw'Invalid callback specified for "complete"';var n=t.complete,r=t.progress||function(){},i=t.error||function(){},s=this,o=new e.Audio,u={},a=!1,f=0,l={},c=!1,h=0,p=2;this.getImage=function(e,n){if(u.hasOwnProperty(e))return u[e];var r=new Image;return typeof n=="function"&&r.addEventListener("load",n,!1),r.src=[t.basePath,e].join("/"),u[e]=r},this.getSound=function(e){return l.hasOwnProperty(e)?l[e]:null},this.loadAssets=function(e,t){a=typeof e=="undefined"||e===null,c=typeof t=="undefined"||t===null;if(a&&c){v();return}a^c&&(p=1),a||m(e),c||g(t)},this.loadStage=function(t,r,o){e.Ajax.getJSON(r,function(r){var i=n;n=function(){n=i,i(s,new e.Stage(r,t))},s.loadAssets(r,o)},function(){i.apply(s,arguments)})}},e.Loader.guessMimeType=function(e){var t=[{pattern:/\.aac$/i,mime:"audio/aac"},{pattern:/\.mp3$/i,mime:"audio/mp3"},{pattern:/\.ogg$/i,mime:"application/ogg"}];for(var n in t)if(t[n].pattern.test(e))return t[n].mime;throw"Couldn't guess the MIME type from the resource URL"},e.Loader.getSourceInfo=function(t){if(typeof t=="string")return{url:t,mimeType:e.Loader.guessMimeType(t)};if(typeof t!="object")throw"Invalid source specified";if(t.hasOwnProperty("url")&&t.hasOwnProperty("mimeType"))return t},e.Loader.prototype.playSound=function(e,t){var n=this.getSound(e);return null!==n&&(n.setLooping(!!t),n.play()),n},e.View=function(t,n){var r=t.matrix,i=function(){var e=r[0][0]*r[1][1]*r[2][2]+r[0][1]*r[1][2]*r[2][0]+r[0][2]*r[1][0]*r[2][1]-r[0][2]*r[1][1]*r[2][0]-r[0][1]*r[1][0]*r[2][2]-r[0][0]*r[1][2]*r[2][1];return[[(r[1][1]*r[2][2]-r[2][1]*r[1][2])/e,(r[0][2]*r[2][1]-r[2][2]*r[0][1])/e,(r[0][1]*r[1][2]-r[1][1]*r[0][2])/e],[(r[1][2]*r[2][0]-r[2][2]*r[1][0])/e,(r[0][0]*r[2][2]-r[2][0]*r[0][2])/e,(r[0][2]*r[1][0]-r[1][2]*r[0][0])/e],[(r[1][0]*r[2][1]-r[2][0]*r[1][1])/e,(r[0][1]*r[2][0]-r[2][1]*r[0][0])/e,(r[0][0]*r[1][1]-r[1][0]*r[0][1])/e]]}(),s=t.x0,o=t.y0,u=n.width,a=n.height;this.project=function(e,t,n){return[r[0][0]*e+r[0][1]*t+r[0][2]*n,r[1][0]*e+r[1][1]*t+r[1][2]*n,Math.round(r[2][0]*e+r[2][1]*t+r[2][2]*n)]},this.projectElement=function(e,t,n,i){return[Math.round(r[0][0]*t+r[0][1]*n+r[0][2]*i+e.offset.x),Math.round(r[1][0]*t+r[1][1]*n+r[1][2]*i+e.offset.y),Math.round(r[2][0]*t+r[2][1]*n+r[2][2]*i)]},this.unproject=function(e,t,n){var r=(n+i[2][0]*(s-e)+i[2][1]*(o-t))/i[2][2],u=i[0][0]*(e-s)+i[0][1]*(t-o)+i[0][2]*r,a=i[1][0]*(e-s)+i[1][1]*(t-o)+i[1][2]*r;return[u,a,n]},this.getCell=function(e,t,n){var r=(n-i[2][0]*(e-s)-i[2][1]*(t-o))/i[2][2],u=Math.round(i[0][0]*(e-s)+i[0][1]*(t-o)+i[0][2]*r),a=Math.round(i[1][0]*(e-s)+i[1][1]*(t-o)+i[1][2]*r);return{i:u,j:a,k:n}},this.getOrigin=function(){return{x:s,y:o}},this.getWidth=function(){return u},this.getHeight=function(){return a};var f=new e.MultiSet;this.drag=function(e,t){s+=e,o+=t,f.fastForEach(function(e){e(s,o)})},this.dragTo=function(e,t){s=e,o=t,f.fastForEach(function(e){e(s,o)})},this.onDrag=function(e){return f.add(e)},this.intersects=function(e,t,n,i,f,l){var c=r[0][0]*e+r[0][1]*t+r[0][2]*n,h=r[1][0]*e+r[1][1]*t+r[1][2]*n,p=r[0][0]*(e+i)+r[0][1]*(t+f)+r[0][2]*(n+l),d=r[1][0]*(e+i)+r[1][1]*(t+f)+r[1][2]*(n+l);return Math.min(c,p)<u-s&&Math.max(c,p)>-s&&Math.min(h,d)<a-o&&Math.max(h,d)>-o},this.Synchronizer=function(e,t,n){this.tick=function(r){var i=s,l=o,c=(u-e)/2,h=(a-t)/2,p=r.getProjectedRectangle();s+p.x+p.width>u-c&&(i=u-p.x-p.width-c),s+p.x<c&&(i=c-p.x),o+p.y+p.height>a-h&&(l=a-p.y-p.height-h),o+p.y<h&&(l=h-p.y),s+=(i-s)*(1-n),o+=(l-o)*(1-n),f.fastForEach(function(e){e(s,o)})}}},e.FrameTable=function(e){function o(e,t){var n;while(t)n=t,t=e%t,e=n;return e}function u(e){if(e.length<2)return function(){return e[0].id};var t=0,n=0,r=!0,i;for(var u in e)e[u].hasOwnProperty("duration")?(t=o(t,e[u].duration),n+=e[u].duration):(r=!1,i=e[u].id);var a={},f=0,l=function(r){a={},f=o(t,r);var i=0,s=0;for(var u=0;u<n;u+=f,s+=f)s>e[i].duration&&(i++,s=0),a[u]=e[i].id};return l(t),s.push(l),r?function(e){return a[Math.floor(e%n/f)*f]}:function(e){return e>=n?i:a[Math.floor(e/f)*f]}}var t={},n={},r={},i=0,s=[];this.registerTile=function(n){if(!e.tiles.hasOwnProperty(n))throw"invalid tile ID: "+n;r[t[n]=i++]=new u(e.tiles[n].frames)},this.registerEntity=function(t){if(!e.entities.hasOwnProperty(t))throw"invalid entity ID: "+t;r[n[t]=i++]=new u(e.entities[t].frames)},this.getTileAnimation=function(e){return r[t[e]]},this.getEntityAnimation=function(e){return r[n[e]]},this.synchronize=function(e){for(var t in s)s[t](e)}},e.Buckets=function(){var t=1,n=1,r=function(r,i){function l(){var t={},n=0,r=0;this.add=function(i,s,o,u,a){return n=Math.min(n,i[2]),r=Math.max(r,i[2]),t[i[2]]||(t[i[2]]=new e.MultiSet),t[i[2]].add({p:i,width:s,height:o,getFrame:u,timeOffset:a})},this.forEach=function(e){for(var i=n;i<=r;i++)t.hasOwnProperty(i)&&t[i].fastForEach(e)}}function h(){this.updatePosition=function(){},this.remove=function(){},this.replace=function(){}}function p(t,n,s,o,d){function S(e,n){var r=e+" "+n;c.hasOwnProperty(r)||(c[r]=new l),w.push(c[r].add(v,t.width,t.height,y,b))}function x(){S(m-1,g-1),S(m-1,g),S(m,g-1),S(m,g);var e=Math.floor((v[1]+t.height)/a),n=Math.floor((v[0]+t.width)/u);e>m&&(S(m+1,g-1),S(m+1,g)),n>g&&(S(m-1,g+1),S(m,g+1)),e>m&&n>g&&S(m+1,g+1)}function T(){for(var e in w)w[e]();return w=[],E=!0,!0}if(!t.frames.length)return new h;var v=r.projectElement(t,s,o,d),m=Math.floor(v[1]/a),g=Math.floor(v[0]/u),y=n(),b=e.Timing.now(),w=[],E=!1;x(),this.getProjectedPosition=function(){return{x:v[0]-t.offset.x,y:v[1]-t.offset.y,z:v[2]}},this.getProjectedRectangle=function(){return{x:v[0],y:v[1],z:v[2],width:t.width,height:t.height}},this.updatePosition=function(e,n,i){if(!E){var f=r.projectElement(t,s=e,o=n,d=i),l=Math.floor(v[1]/a),c=Math.floor(v[0]/u);f[2]!==v[2]||l!==m||c!==g?(T(),E=!1,v[0]=f[0],v[1]=f[1],v[2]=f[2],m=l,g=c,x()):(v[0]=f[0],v[1]=f[1],v[2]=f[2])}},this.remove=T,this.isRemoved=function(){return E},this.replace=function(e){if(!E){if(e in i.entities){T();var t=i.entities[e];return new p(t,function(){return f.getEntityAnimation(e)},s,o,d)}throw{message:"invalid entity ID",id:e}}}}function v(e,t,n,r){if(e in i.tiles){var s=i.tiles[e],o=(new p(s,function(){return f.getTileAnimation(e)},t,n,r)).remove;if(s.mutable){d[r]||(d[r]={}),d[r][t]||(d[r][t]={});var u=!1;return d[r][t][n]=function(){return o(),u?!1:(delete d[r][t][n],u=!0,!0)}}return o}throw{message:"invalid tile ID",id:e}}var s=r.getWidth(),o=r.getHeight(),u=Math.round(s*t),a=Math.round(o*n),f=new e.FrameTable(i);(function(){var e;for(e in i.tiles)f.registerTile(e);for(e in i.entities)f.registerEntity(e)})();var c={},d={};this.addTile=v,this.addEntity=function(e,t,n,r){if(e in i.entities){var s=i.entities[e];return new p(s,function(){return f.getEntityAnimation(e)},t,n,r)}throw{message:"invalid entity ID",id:e}},this.removeTile=function(e,t,n){return d[n]&&d[n][e]&&d[n][e][t]&&d[n][e][t]()||!1},this.replaceTile=function(e,t,n,r){if(d[n]&&d[n][e]&&d[n][e][t]&&d[n][e][t]())return v(r,e,t,n)},this.synchronize=f.synchronize,this.forEachElement=function(t){var n=r.getOrigin(),i=Math.floor(-n.y/a),f=Math.floor(-n.x/u),l=i+" "+f;if(c.hasOwnProperty(l)){var h=e.Timing.now();c[l].forEach(function(e){e.p[0]<-n.x+s&&e.p[1]<-n.y+o&&e.p[0]+e.width>=-n.x&&e.p[1]+e.height>=-n.y&&t(e.p[0],e.p[1],e.getFrame(h-e.timeOffset))})}}};return r.setBucketSizeFactors=function(e,r){if(e<1)throw"illegal width factor: "+e;if(r<1)throw"illegal height factor: "+r;t=e,n=r},r}(),e.Renderer=function(e,t,n,r,i,s){if(typeof e=="string"){e=document.querySelector(e);if(!e)throw"No element found matching the specified selector"}var o=e.width,u=e.height,a=e.getContext("2d");this.getView=function(){return n},this.getBuckets=function(){return r},this.synchronize=r.synchronize,this.getContext=function(){return a},this.render=function(){var e=n.getOrigin();a.setTransform(1,0,0,1,e.x,e.y),a.clearRect(-e.x,-e.y,o,u),i&&i(a),r.forEachElement(function(e,n,r){a.drawImage(t.getImage(r),e,n)}),s&&s(a)}},e.TileMap=function(t,n){function o(e){var n=t.tiles[e];this.isWalkable=function(){return n.walkable},this.getProperties=function(){return n.properties}}function u(e,t){for(var n in t)if(t.hasOwnProperty(n)){var r;if(!(n in e))return!1;r=e[n];if(typeof t[n]!="object"){if(r!==t[n])return!1}else if(typeof r!="object"||!u(r,t[n]))return!1}return!0}function a(e){var n=[];for(var r in t.tiles)u(t.tiles[r].properties,e)&&n.push(r);return n}function f(e){for(var n in t.tiles)if(u(t.tiles[n].properties,e))return n}var r=this,i=t.map,s={};this.forEachLayer=function(e){for(var t in i)if(e(parseInt(t,10))===!1)return!0;return!1},this.forEachTile=function(e){for(var t in i){t=parseInt(t,10);for(var n in i[t]){n=parseInt(n,10);for(var r in i[t][n]){r=parseInt(r,10);if(e(n,r,t)===!1)return!0}}}return!1},this.forEachTileInLayer=function(e,t){if(e in i){for(var n in i[e]){n=parseInt(n,10);for(var r in i[e][n]){r=parseInt(r,10);if(t(n,r)===!1)return!0}}return!1}throw"invalid layer number: "+e},this.getTileIds=a,this.getTileId=f,this.getTile=function(e){var n;if(typeof e!="object"){n=e;if(n in t.tiles)return s[n]||(s[n]=new o(n));throw"invalid tile id: "+n}return n=f(e),s[n]||(s[n]=new o(n))},this.getTiles=function(e){var t=a(e),n=[];for(var r in t)n.push(s[t[r]]||(s[t[r]]=new o(t[r])));return n},this.getAt=function(e,t,n){return i[n]&&i[n][e]&&i[n][e][t]||!1},this.putAt=function(e,r,s,o){if(!(o in t.tiles))throw{message:"invalid tile ID",id:o};if(!(s in i&&e in i[s]&&r in i[s][e]))return s in i||(i={}),e in i[s]||(i[s]={}),i[s][e][r]=o,n.addTile(o,e,r,s),!0;if(!n.replaceTile(e,r,s,o))return!1;i[s][e][r]=o};var l;this.findPath=function(t,n,i,s,o){l||(l=new e.Astar);var u=l.findPath(r.getGraphNode(t,n,i,s,o)),a=[];for(var f=0;f<u.length;++f)t+=[-1,-1,-1,0,0,0,1,1,1][u[f]],n+=[-1,0,1,-1,0,1,-1,0,1][u[f]],a.push({i:t,j:n});return a},this.getGraphNode=function(e,n,r,s,o){return function u(e,n){function a(e,t){return function(){return u(e,t)}}var f=Math.abs(s-e),l=Math.abs(o-n),c={id:e+" "+n+" "+r,heuristic:Math.sqrt(Math.pow(Math.min(f,l),2)*2)+Math.max(f,l)-Math.min(f,l),neighbors:{},distance:function(e){return parseInt(e,10)%2?1:Math.sqrt(2)}};return function(){function s(e,n){return e in i[r]&&n in i[r][e]&&t.tiles[i[r][e][n]].walkable}for(var o=0;o<9;o++){var u=e+[-1,-1,-1,0,0,0,1,1,1][o],f=n+[-1,0,1,-1,0,1,-1,0,1][o];(u===e||f===n)&&s(u,f)&&(o%2||s(e,f)&&s(u,n))&&(c.neighbors[o]=a(u,f))}}(),c}(e,n)},this.rectangleCollision=function(e,n,r,i,s,o,u,a){var f=0,l=0,c=0,h=0,p=t.map;if(e in t.map){var d=t.tiles,v=function(){return typeof a!="function"?function(t,n){return t in p[e]&&n in p[e][t]&&!d[p[e][t][n]].walkable}:function(t,n){var r=d[p[e][t][n]];return t in p[e]&&n in p[e][t]&&a(r.walkable,r.properties)}}(),m=Math.floor(n),g=Math.floor(r),y=Math.ceil(n+i)-1,b=Math.ceil(r+s)-1;for(var w=g;w<=b;w++)v(m,w)&&(m===y||!v(m+1,w))&&(f=m+1-n),v(y,w)&&(m===y||!v(y-1,w))&&(l=y-n-i);for(var E=m;E<=y;E++)v(E,g)&&(g===b||!v(E,g+1))&&(c=g+1-r),v(E,b)&&(g===b||!v(E,b-1))&&(h=b-r-s)}var S={};return f&&l?S.i=0:f?S.i=f:S.i=l,c&&h?S.j=0:c?S.j=c:S.j=h,Math.abs(S.i)>Math.abs(o)+.001&&(S.i=0),Math.abs(S.j)>Math.abs(u)+.001&&(S.j=0),S}},e.Stage=function(t,n){function f(e,t,n){for(var r in t)if(t.hasOwnProperty(r)){var i;if(r in e)i=e[r];else{if(!(r in n))return!1;i=n[r]}if(typeof t[r]!="object"){if(i!==t[r])return!1}else if(typeof i!="object"||!f(i,t[r],{}))return!1}return!0}function l(e){var n=t.entities[e=parseInt(e,10)];e in o||(o[e]=this),this.getId=function(){return e},this.getProperties=function(){return n.properties},this.isPhysicsEnabled=function(){return n.enablePhysics},this.getBoundingBox=function(){return n.box},this.forEachInstance=function(t,r){return r||(r={}),u.forEach(function(i){if(e===i.getEntityId()&&f(i.getProperties(),r,n.properties))return t(i)})},this.createInstance=function(t,n,r){return new c({id:e,i:t,j:n,k:r,position:{i:t,j:n,k:r},previousPosition:{i:t,j:n,k:r},velocity:{i:0,j:0,k:0},uniformVelocity:{i:0,j:0,k:0},acceleration:{i:0,j:0,k:0},properties:{}},i.addEntity(e,t,n,r))}}function c(e,n){var f,h;typeof e!="number"?(f=null,h=e):(f=e,h=t.instances[f]);var p=t.entities[h.id],d=u.add(this);p.enablePhysics&&(d=function(e,t){return function(){return e()&&t()}}(d,a.add(this))),this.getId=function(){return f},this.getProperties=function(){return h.properties},this.getEntityId=function(){return h.id},this.getEntity=function(){return o[h.id]||new l(h.id)},this.isPhysicsEnabled=function(){return p.enablePhysics},this.getPosition=function(){return h.position},this.getProjectedPosition=n.getProjectedPosition,this.getProjectedRectangle=n.getProjectedRectangle,this.inRange=function(){var e=r.getWidth(),t=r.getHeight();return function(i,s){var o=n.getProjectedPosition(),u=r.getOrigin(),a=(i-e)/2,f=(s-t)/2;return o.x>=-u.x-a&&o.x<=-u.x+e+a&&o.y>=-u.y-f&&o.y<=-u.y+t+f}}(),this.getVelocity=function(){return h.velocity},this.getUniformVelocity=function(){return h.uniformVelocity},this.getFullVelocity=function(){var e={i:h.velocity.i+h.uniformVelocity.i,j:h.velocity.j+h.uniformVelocity.j,k:h.velocity.k+h.uniformVelocity.k};return function(){return e.i=h.velocity.i+h.uniformVelocity.i,e.j=h.velocity.j+h.uniformVelocity.j,e.k=h.velocity.k+h.uniformVelocity.k,e}}(),this.getAcceleration=function(){return h.acceleration},this.testTileCollision=function(e,t){return(t||s).rectangleCollision(Math.floor(h.k),h.position.i+p.box.i0,h.position.j+p.box.j0,p.box.iSpan,p.box.jSpan,h.position.i-h.previousPosition.i,h.position.j-h.previousPosition.j,e)},this.tileCollision=function(e,t){var n=(t||s).rectangleCollision(Math.floor(h.k),h.position.i+p.box.i0,h.position.j+p.box.j0,p.box.iSpan,p.box.jSpan,h.position.i-h.previousPosition.i,h.position.j-h.previousPosition.j,e);return h.position.i+=n.i,h.position.j+=n.j,n.i>0&&h.velocity.i<0?h.velocity.i=0:n.i<0&&h.velocity.i>0&&(h.velocity.i=0),n.j>0&&h.velocity.j<0?h.velocity.j=0:n.j<0&&h.velocity.j>0&&(h.velocity.j=0),n},this.collidesWithTiles=function(e,t){var n=(t||s).rectangleCollision(Math.floor(h.k),h.position.i+p.box.i0,h.position.j+p.box.j0,p.box.iSpan,p.box.jSpan,h.position.i-h.previousPosition.i,h.position.j-h.previousPosition.j,e);return h.position.i+=n.i,h.position.j+=n.j,n.i>0&&h.velocity.i<0?h.velocity.i=0:n.i<0&&h.velocity.i>0&&(h.velocity.i=0),n.j>0&&h.velocity.j<0?h.velocity.j=0:n.j<0&&h.velocity.j>0&&(h.velocity.j=0),n.i||n.j},this.rectangleCollision=function(e,t,n,r,i,s){var o={i:0,j:0};return e<h.position.i+p.box.i0?e+n>h.position.i+p.box.i0&&(t<h.position.j+p.box.j0?t+r>h.position.j+p.box.j0&&(e+n<h.position.i+p.box.i0+p.box.iSpan&&(o.i=h.position.i+p.box.i0-e-n),t+r<h.position.j+p.box.j0+p.box.jSpan&&(o.j=h.position.j+p.box.j0-t-r)):t<h.position.j+p.box.j0+p.box.jSpan&&(e+n<h.position.i+p.box.i0+p.box.iSpan&&(o.i=h.position.i+p.box.i0-e-n),t+r>h.position.j+p.box.j0+p.box.jSpan&&(o.j=h.position.j+p.box.j0-t-r))):e<h.position.i+p.box.i0+p.box.iSpan&&(t<h.position.j+p.box.j0?t+r>h.position.j+p.box.j0&&(o.i=h.position.i+p.box.i0+p.box.iSpan-e,t+r<h.position.j+p.box.j0+p.box.jSpan&&(o.j=h.position.j+p.box.j0-t-r)):t<h.position.j+p.box.j0+p.box.jSpan&&(e+n>h.position.i+p.box.i0+p.box.iSpan&&(o.i=h.position.i+p.box.i0+p.box.iSpan-e),t+r>h.position.j+p.box.j0+p.box.jSpan&&(o.j=h.position.j+p.box.j0+p.box.jSpan-t))),Math.abs(o.i)>Math.abs(h.position.i-h.previousPosition.i-i)+.001&&(o.i=0),Math.abs(o.j)>Math.abs(h.position.j-h.previousPosition.j-s)+.001&&(o.j=0),o},this.testCollision=function(e){return e.rectangleCollision(h.position.i+p.box.i0,h.position.j+p.box.j0,p.box.iSpan,p.box.jSpan,h.position.i-h.previousPosition.i,h.position.j-h.previousPosition.j)},this.collision=function(e){var t=e.rectangleCollision(h.position.i+p.box.i0,h.position.j+p.box.j0,p.box.iSpan,p.box.jSpan,h.position.i-h.previousPosition.i,h.position.j-h.previousPosition.j);return h.position.i+=t.i,h.position.j+=t.j,t.i>0&&h.velocity.i<0?h.velocity.i=0:t.i<0&&h.velocity.i>0&&(h.velocity.i=0),t.j>0&&h.velocity.j<0?h.velocity.j=0:t.j<0&&h.velocity.j>0&&(h.velocity.j=0),t},this.collidesWithInstance=function(e){var t=e.rectangleCollision(h.position.i+p.box.i0,h.position.j+p.box.j0,p.box.iSpan,p.box.jSpan,h.position.i-h.previousPosition.i,h.position.j-h.previousPosition.j);return h.position.i+=t.i,h.position.j+=t.j,t.i>0&&h.velocity.i<0?h.velocity.i=0:t.i<0&&h.velocity.i>0&&(h.velocity.i=0),t.j>0&&h.velocity.j<0?h.velocity.j=0:t.j<0&&h.velocity.j>0&&(h.velocity.j=0),t.i||t.j},this.tick=function(e){var t=e*e*.5;h.previousPosition.i=h.position.i,h.previousPosition.j=h.position.j,h.previousPosition.k=h.position.k,h.position.i+=(h.velocity.i+h.uniformVelocity.i)*e+h.acceleration.i*t,h.position.j+=(h.velocity.j+h.uniformVelocity.j)*e+h.acceleration.j*t,h.position.k+=(h.velocity.k+h.uniformVelocity.k)*e+h.acceleration.k*t,h.velocity.i+=h.acceleration.i*e,h.velocity.j+=h.acceleration.j*e,h.velocity.k+=h.acceleration.k*e},this.update=function(){n.updatePosition(h.position.i,h.position.j,h.position.k)},this.remove=function(){n.remove(),d()},this.isRemoved=n.isRemoved,this.replaceWith=function(e){if(d())return new c(h,n.replace(h.id=e.getId()));throw"the instance cannot be replaced because it has been removed"},this.fork=function(e){var t=e?e.getId():h.id;return new c({id:t,i:h.i,j:h.j,k:h.k,position:{i:h.position.i,j:h.position.j,k:h.position.k},previousPosition:{i:h.previousPosition.i,j:h.previousPosition.j,k:h.previousPosition.k},velocity:{i:h.velocity.i,j:h.velocity.j,k:h.velocity.k},uniformVelocity:{i:h.uniformVelocity.i,j:h.uniformVelocity.j,k:h.uniformVelocity.k},acceleration:{i:h.acceleration.i,j:h.acceleration.j,k:h.acceleration.k},properties:{}},i.addEntity(t,h.position.i,h.position.j,h.position.k))}}if(typeof n=="string"){n=document.querySelector(n);if(!n)throw"No element found matching the specified selector"}var r=new e.View(t,n),i=new e.Buckets(r,t),s=null,o={},u=new e.MultiSet,a=new e.MultiSet;(function(){for(var n in t.map){n=parseInt(n,10);for(var r in t.map[n]){r=parseInt(r,10);for(var o in t.map[n][r])o=parseInt(o,10),i.addTile(t.map[n][r][o],r,o,n)}}for(var u in t.instances){var a=t.instances[u];a.position={i:a.i,j:a.j,k:a.k},a.previousPosition={i:a.i,j:a.j,k:a.k},a.velocity={i:0,j:0,k:0},a.uniformVelocity={i:0,j:0,k:0},a.acceleration={i:0,j:0,k:0},new c(parseInt(u,10),i.addEntity(a.id,a.i,a.j,a.k))}s=new e.TileMap(t,i)})(),this.getName=function(){return t.name},this.getProperties=function(){return t.properties},this.getCanvas=function(){return n},this.getView=function(){return r},this.getBuckets=function(){return i},this.getTileMap=function(){return s},this.forEachEntity=function(e,n){n||(n={});for(var r in t.entities)if(t.entities.hasOwnProperty(r)&&f(t.entities[r].properties,n,{})&&e(o[r]||new l(r))===!1)return!0;return!1},this.getEntities=function(e){var n=[];for(var r in t.entities)t.entities.hasOwnProperty(r)&&f(t.entities[r].properties,e||{},{})&&n.push(o[r]||new l(r));return n},this.getEntity=function(e){for(var n in t.entities)if(t.entities.hasOwnProperty(n)&&f(t.entities[n].properties,e||{},{}))return o[n]||new l(n);return null},this.forEachInstance=function(e,t){return u.forEach(function(n){if(f(n.getProperties(),t||{},n.getEntity().getProperties()))return e(n)})},this.getInstances=function(e){var t=[];return u.forEach(function(n){f(n.getProperties(),e||{},n.getEntity().getProperties())&&t.push(n)}),t},this.getInstance=function(e){var t=null;return u.forEach(function(n){if(f(n.getProperties(),e||{},n.getEntity().getProperties()))return t=n,!1}),t},this.Range=function(e,t){this.forEachInstance=function(n,r){return r||(r={}),u.forEach(function(i){if(i.inRange(e,t)&&f(i.getProperties(),r,i.getEntity().getProperties()))return n(i)})},this.tick=function(n){a.fastForEach(function(r){r.inRange(e,t)&&r.tick(n)})},this.update=function(){a.fastForEach(function(n){n.inRange(e,t)&&n.update()})}},this.tick=function(e){a.fastForEach(function(t){t.tick(e)})},this.update=function(){a.fastForEach(function(e){e.update()})}},e.StageRenderer=function(t,n){var r=[],i=new e.Renderer(t.getCanvas(),n,t.getView(),t.getBuckets(),function(e){for(var t=0;t<r.length;t++)r[t].isOver()?r.splice(t--,1):r[t].preProcess&&r[t].preProcess(e)},function(e){for(var t=r.length-1;t>=0;t--)r[t].postProcess&&r[t].postProcess(e)});return i.addEffect=function(e){r.push(e)},i},e.DebugEffect=function(e,t){function i(e,t,n,i,s,o){var u=[r.project(t,n,i),r.project(t+s,n,i),r.project(t+s,n+o,i),r.project(t,n+o,i)];e.moveTo(u[0][0],u[0][1]),e.lineTo(u[1][0],u[1][1]),e.lineTo(u[2][0],u[2][1]),e.lineTo(u[3][0],u[3][1]),e.lineTo(u[0][0],u[0][1])}function s(e,t,n){var i=r.project(t.i,t.j,t.k),s=r.project(t.i+n.i,t.j+n.j,t.k+n.k);e.moveTo(i[0],i[1]),e.lineTo(s[0],s[1])}var n=!0,r=e.getView();this.enable=function(){n=!0},this.disable=function(){n=!1},this.toggle=function(e){return arguments.length<1?n=!n:n=!!e},this.isEnabled=function(){return n},this.getOption=function(e){return t[e]},this.setOption=function(e,n){t[e]=n},this.isOver=function(){return!1},this.postProcess=function(o){if(n){o.save(),o.globalAlpha=1,o.globalCompositeOperation="source-over",o.lineWidth=1,o.lineCap="butt",o.shadowOffsetX=0,o.shadowOffsetY=0,o.shadowBlur=0,o.shadowColor="transparent",t.drawBoundingBoxes&&(o.strokeStyle=t.boundingBoxStyle||"#FF0000",o.beginPath(),e.forEachInstance(function(e){var t=e.getPosition(),n=e.getEntity().getBoundingBox();i(o,t.i+n.i0,t.j+n.j0,t.k,n.iSpan,n.jSpan)}),o.stroke()),t.drawVelocity&&(o.strokeStyle=t.velocityStyle||"#FF0000",o.beginPath(),e.forEachInstance(function(e){e.isPhysicsEnabled()&&s(o,e.getPosition(),e.getVelocity())}),o.stroke()),t.drawUniformVelocity&&(o.strokeStyle=t.uniformVelocityStyle||"#FF0000",o.beginPath(),e.forEachInstance(function(e){e.isPhysicsEnabled()&&s(o,e.getPosition(),e.getUniformVelocity())}),o.stroke()),t.drawAcceleration&&(o.strokeStyle=t.accelerationStyle||"#FF0000",o.beginPath(),e.forEachInstance(function(e){e.isPhysicsEnabled()&&s(o,e.getPosition(),e.getAcceleration())}),o.stroke());if(t.drawSolidMap){var u=e.getTileMap();o.fillStyle=t.solidMapStyle||"#FF0000",o.beginPath(),u.forEachTile(function(e,t,n){r.intersects(e,t,n,1,1,1)&&!u.getTile(u.getAt(e,t,n)).isWalkable()&&i(o,e,t,n,1,1)}),o.fill()}o.restore()}}},e.RumbleEffect=function(t,n){typeof n=="undefined"&&(n={});var r="period"in n?~~n.period:e.RumbleEffect.defaultPeriod,i="extent"in n?~~n.extent:e.RumbleEffect.defaultExtent,s="horizontal"in n?!!n.horizontal:!0,o="vertical"in n?!!n.vertical:!0,u=1;this.preProcess=function(e){if(--t>0){u=t%r?u:-u;var n=s?u*i:0,a=o?u*i:0;e.translate(n,a)}},this.isOver=function(){return t<=0}},e.RumbleEffect.defaultPeriod=3,e.RumbleEffect.defaultExtent=2,e.RenderLoop=function(){function r(r,i,s,o,u){function w(e){d.tick(e),typeof o=="function"&&o(e)}function E(e,t){e=Math.min(e,c);while(e>l)w(l/1e3),e-=l;w(e/1e3),d.update(),typeof u=="function"&&u(),b++,a.render(t)}function S(){if(!h||p){h=!0,p=!1;var t=e.Timing.now(),n=t;y=m(function r(){var i=e.Timing.now(),s=i-t,o=i-n;n=i,E(o,s),y=m(r)},v)}}function x(){if(!h||p){h=!0,p=!1;var t=e.Timing.now(),n=t;y=setInterval(function(){var r=e.Timing.now(),i=r-t,s=r-n;n=r,E(s,i)},l)}}var a=new e.StageRenderer(r,s),f=n,l=Math.floor(1e3/f),c=5e3,h=!1,p=!1,d=i||r,v=r.getCanvas(),m=e.Polyfill.getPrefixedProperty("requestAnimationFrame"),g=e.Polyfill.getPrefixedProperty("cancelAnimationFrame"),y;a.synchronize(l),this.getRate=function(){return f};var b=0;this.getActualRate=function(){var t=e.Timing.now();return function(){if(h&&!p){var n=e.Timing.now(),r=b*1e3/(n-t);return b=0,t=n,r}return null}}(),this.getPeriod=function(){return l},this.getMaximumPeriod=function(){return c},this.setMaximumPeriod=function(e){c=e},this.getStage=function(){return r},this.getRenderer=function(){return a};var T;t==="request"?T=g:t==="interval"?T=clearInterval:m?T=g:T=clearInterval,t==="request"?this.run=S:t==="interval"?this.run=x:m?this.run=S:this.run=x,this.suspend=function(){h&&!p&&(T(y),p=!0)},this.isSuspended=function(){return h&&p},this.stop=function(){h&&(T(y),h=!1,p=!0)},this.isStopped=function(){return!h&&p}}var t="auto",n=60;return r.setLoop=function(e,r){if(!(e in{request:!0,interval:!0,auto:!0}))throw'invalid loop type; only "request", "interval" and "auto" are allowed.';t=e,typeof r=="number"&&(n=r)},r}(),e.Animator=function(t){function r(t,n,r,i,s){var o=t.i,u=t.j,a=t.k,f=n.i-t.i,l=n.j-t.j,c=n.k-t.k,h=e.Timing.now(),p=h+r;this.tick=function(e){var s=i((e-h)/r);return"i"in n&&(t.i=o+f*s),"j"in n&&(t.j=u+l*s),"k"in n&&(t.k=a+c*s),e<p},this.callback=s}function s(t){return function(i,s,o,u){arguments.length<4&&(u={}),typeof u.easing=="string"&&(u.easing=e.Animator.Easing[u.easing]),typeof u.easing=="undefined"&&(u.easing=e.Animator.Easing.linear),typeof u.callback!="undefined"&&(u.callback=function(e){return function(){e.call(i)}}(u.callback)),n.add(new r(i[t](),s,o,u.easing,u.callback))}}var n=new e.MultiSet,i=function(){var r=e.Timing.now();n.forEach(function(e,t){e.tick(r)||(t(),e.callback&&e.callback())}),t&&t.call(i)};return i.tick=function(e){return t=e,i},i.interpolatePosition=s("getPosition"),i.interpolateVelocity=s("getVelocity"),i.interpolateUniformVelocity=s("getUniformVelocity"),i.interpolateAcceleration=s("getAcceleration"),i},e.Animator.Easing={linear:function(e){return e},acceleration:function(e){return e*e},deceleration:function(e){return 1-Math.pow(e-1,2)},backAndForth:function(e){return Math.pow(2*e-1,3)-e+1},harmonic:function(e){return 1-Math.sin(50*e)/(50*e)}},e.Audio=function(){var t=function(){return function(){try{return new Audio}catch(e){return document.createElement("audio")}}()},n=e.Polyfill.getPrefixedProperty("AudioContext"),r=t();this.load=function(e,t,n){return new i(e,t,n)},this.canPlayType=function(e){return r.canPlayType(e)!==""};var i=null;if(typeof n!="undefined"){var s=new n;i=function(t,n,r){var o=this,u=null,a=null,f=0,l=0,c=!1,h=!1;return this.play=function(){var t=f/1e3,n=a.duration-t;return a&&(u=s.createBufferSource(),u.buffer=a,u.loop=c,u.connect(s.destination),l=e.Timing.now(),u.noteGrainOn(0,t,n)),o},this.pause=function(){return u&&(u.noteOff(0),u.disconnect(),f+=e.Timing.now()-l),o},this.clone=function(){var e=new i(a);return e.setLooping(c),e},this.isLoaded=function(){return h},this.setLooping=function(e){return c=e,u&&(u.loop=e),o},typeof t!="string"?(a=t,this):(e.Ajax.get({type:"arraybuffer",url:t,load:function(e){s.decodeAudioData(e,function(e){a=e,h=!0,typeof n=="function"&&n(o)},function(){typeof r=="function"&&r(t)})},error:function(){typeof r=="function"&&r()}}),this)}}else typeof r!="undefined"&&(i=function(e,n,r){var s=this,o=!1,u=!1,a=null;return this.play=function(){return o||(document.body.appendChild(a),o=!0),a.play(),s},this.pause=function(){return a.pause(),s},this.clone=function(){var e=new i(a.cloneNode(!0));return e.setLooping(a.loop),e},this.isLoaded=function(){return u},this.setLooping=function(e){return a.loop=!!e,s},typeof e!="string"?(a=e,u=!0):(a=t(),function(){var e=function(e){var t=function(){a.removeEventListener(e,t,!1),u||(u=!0,typeof n=="function"&&n(s))};a.addEventListener(e,t,!1)};e("canplay"),e("canplaythrough")}(),a.addEventListener("error",function(e){typeof r=="function"&&r(e)},!1),a.setAttribute("preload","auto"),a.setAttribute("src",e),a.load()),a.addEventListener("ended",function(){o&&!a.loop&&(document.body.removeChild(a),o=!1)},!1),this});i.prototype.playClone=function(){var e=this.clone();return e.play(),e}},e.onVisibilityChange=function(e){if("hidden"in document)document.addEventListener("visibilitychange",function(){e(document.hidden)},!1);else if("webkitHidden"in document)document.addEventListener("webkitvisibilitychange",function(){e(document.webkitHidden)},!1);else if("mozHidden"in document)document.addEventListener("mozvisibilitychange",function(){e(document.mozHidden)},!1);else{if(!("msHidden"in document))return!1;document.addEventListener("msvisibilitychange",function(){e(document.msHidden)},!1)}return!0},e}();