/*! Canvace Game Engine - v1.0.0 - 2013-11-04
 * http://www.canvace.com/
 * Copyright (c) 2013 Canvace Srl */
var Canvace=function(){"use strict";function a(){if(0!==arguments.length){var a=arguments[0];return a.tagName?a:document.querySelector(a)}}return a.mixin=function(b,c){if("object"==typeof c)for(var d in c)c.hasOwnProperty(d)&&(b[d]=a.clone(c[d]));return b},a.clone=function(b){var c;if("object"==typeof b)return c=Object.getPrototypeOf(b)?Object.create(Object.getPrototypeOf(b)):{},a.mixin(c,b),c;if(Array.isArray(b)){c=[];for(var d=0;d<b.length;++d)c[d]=a.clone(b[d]);return c}return b},a.extend=function(b){for(var c=a.clone(b),d=1;d<arguments.length;++d)a.mixin(c,arguments[d]);return c},a.MultiSet=function(){this.elements={},this.nextId=0,this.count=0,this.resetCount=0,this.fastAdd.apply(this,arguments)},a.MultiSet.prototype.add=function(a){var b=this.nextId++;this.elements[b]=a,this.count++;var c=this.resetCount;return function(){return c<this.resetCount?!1:this.elements.hasOwnProperty(b)?(delete this.elements[b],this.count--,!0):!1}.bind(this)},a.MultiSet.prototype.fastAdd=function(){for(var a in arguments)arguments.hasOwnProperty(a)&&(this.elements[this.nextId++]=arguments[a]);this.count+=arguments.length},a.MultiSet.prototype.forEach=function(a){for(var b in this.elements)if(this.elements.hasOwnProperty(b)&&a(this.elements[b],function(a){var b=this.resetCount;return function(){return b<this.resetCount?!1:this.elements.hasOwnProperty(a)?(delete this.elements[a],this.count--,!0):!1}.bind(this)}.call(this,b))===!1)return!0;return!1},a.MultiSet.prototype.fastForEach=function(a){for(var b in this.elements)this.elements.hasOwnProperty(b)&&a(this.elements[b])},a.MultiSet.prototype.count=function(){return this.count},a.MultiSet.prototype.isEmpty=function(){return!this.count},a.MultiSet.prototype.clear=function(){this.elements={},this.count=0,this.resetCount++},"function"!=typeof Array.prototype.forEach&&(Array.prototype.forEach=function(a,b){for(var c=0,d=this.length;d>c;++c)a.call(b,this[c],c,this)}),"function"!=typeof Array.isArray&&(Array.isArray=function(a){return"[object Array]"===Object.prototype.toString.call(a)}),a.Polyfill=function(){function a(a,b){var c=b.charAt(0).toUpperCase()+b.substr(1);for(var e in d)if(d.hasOwnProperty(e)){var f=d[e]+c;if(f in a)return a[f]}return a[b]}function b(b,c){var d=a(b,c);return"function"==typeof d?function(){return d.apply(b,arguments)}:d}function c(a){return function(b,c){if(arguments.length<2&&(c=b,b=window),Array.isArray(c))for(;c.length>1;){var d=a(b,c.shift());if("undefined"!=typeof d)return d}return a(b,c.toString())}}var d=["webkit","moz","ms","o"];return{vendorPrefixes:d,getPrefixedProperty:c(b),getPrefixedConstructor:c(a)}}(),a.Ajax=new function(){function b(a){function b(b,c,e){function f(a){for(var b in a)a.hasOwnProperty(b)&&d.setRequestHeader(b,a[b])}d.open(a.method,b,a.async,a.user,a.password),d.responseType="json"===a.type?"text":a.type,f(c),f(a.headers),arguments.length<3?d.send():d.send(e)}var c=this;"undefined"==typeof a.async&&(a.async=!0),"undefined"==typeof a.type&&(a.type=""),"undefined"==typeof a.user&&(a.user=""),"undefined"==typeof a.password&&(a.password="");var d=new XMLHttpRequest;if(d.addEventListener("load",function(){"function"==typeof a.load&&a.load.call(c,function(){switch(a.type){case"":case"text":return d.responseText;case"json":return JSON.parse(d.responseText);case"document":return d.responseXML;default:return d.response}}())},!1),d.addEventListener("error",function(){"function"==typeof a.error&&a.error.call(c,d.status,d.statusText)},!1),"undefined"!=typeof a.data){var e=function f(a,b){switch(typeof b){case"undefined":return[a+"undefined"];case"boolean":case"number":case"string":return[a+encodeURIComponent(""+b)];case"object":var c=[];if(Array.isArray(b))b.forEach(function(b,d){c.push.apply(c,f(encodeURIComponent(a+"["+d+"]")+"=",b))});else{if(!b)return[a+"null"];for(var d in b)b.hasOwnProperty(d)&&c.push.apply(c,f(encodeURIComponent(a+"."+d)+"=",b[d]))}return c;default:throw"invalid data"}}("",a.data).join("&");"GET"!==a.method.toUpperCase()?b(a.url,{"Content-Type":"application/x-www-form-urlencoded"},e):b(a.url+"?"+e)}else b(a.url);this.onLoad=function(b){return a.load=b,c},this.onError=function(b){return a.error=b,c}}function c(a,c){return c.length<2?"object"!=typeof c[0]?new b({method:a,url:c[0]}):function(){var d={};for(var e in c[0])c[0].hasOwnProperty(e)&&(d[e]=c[0][e]);return d.method=a,new b(d)}():c.length<3?"function"!=typeof c[1]?new b({method:a,url:c[0],data:c[1]}):new b({method:a,url:c[0],load:c[1]}):c.length<4?function(){var d={method:a,url:c[0]};if("object"==typeof c[1]&&"function"==typeof c[2])d.data=c[1],d.load=c[2];else{if("function"!=typeof c[1]||"string"!=typeof c[2])throw"invalid arguments";d.load=c[1],d.type=c[2]}return new b(d)}():new b({method:a,url:c[0],data:c[1],load:c[2],type:c[3]})}function d(a){return function(){return c(a,arguments)}}this.get=d("GET"),this.post=d("POST"),this.put=d("PUT"),this._delete=d("DELETE"),this.getJSON=function(b,c,d){return a.Ajax.get({url:b,type:"json",load:c,error:d})}},a.Animator=function(b){function c(b,c,d,e,f){var g=b.i,h=b.j,i=b.k,j=c.i-b.i,k=c.j-b.j,l=c.k-b.k,m=a.Timing.now(),n=m+d;this.tick=function(a){var f=e((a-m)/d);return"i"in c&&(b.i=g+j*f),"j"in c&&(b.j=h+k*f),"k"in c&&(b.k=i+l*f),n>a},this.callback=f}function d(b){return function(d,f,g,h){arguments.length<4&&(h={}),"string"==typeof h.easing&&(h.easing=a.Animator.Easing[h.easing]),"undefined"==typeof h.easing&&(h.easing=a.Animator.Easing.linear),"undefined"!=typeof h.callback&&(h.callback=function(a){return function(){a.call(d)}}(h.callback)),e.add(new c(d[b](),f,g,h.easing,h.callback))}}var e=new a.MultiSet,f=function(){var c=a.Timing.now();e.forEach(function(a,b){a.tick(c)||(b(),a.callback&&a.callback())}),b&&b.call(f)};return f.tick=function(a){return b=a,f},f.interpolatePosition=d("getPosition"),f.interpolateVelocity=d("getVelocity"),f.interpolateUniformVelocity=d("getUniformVelocity"),f.interpolateAcceleration=d("getAcceleration"),f},a.Animator.Easing={linear:function(a){return a},acceleration:function(a){return a*a},deceleration:function(a){return 1-Math.pow(a-1,2)},backAndForth:function(a){return Math.pow(2*a-1,3)-a+1},harmonic:function(a){return 1-Math.sin(50*a)/(50*a)}},a.AppCache=new function(){var b={cached:new a.MultiSet,checking:new a.MultiSet,downloading:new a.MultiSet,progress:new a.MultiSet,error:new a.MultiSet,updateready:new a.MultiSet,noupdate:new a.MultiSet,obsolete:new a.MultiSet};if(window.applicationCache)for(var c in b)b.hasOwnProperty(c)&&applicationCache.addEventListener(c,function(a){return function(b){a.fastForEach(function(a){a(b)})}}(b[c]),!1);this.on=function(a,c){if(b.hasOwnProperty(a))return b[a].add(c);throw'no such event "'+a+'"'}},a.AppCache.getStatus=function(){return window.applicationCache?applicationCache.status:void 0},a.AppCache.update=function(){return window.applicationCache?applicationCache.update():void 0},a.AppCache.abort=function(){return window.applicationCache?applicationCache.abort():void 0},a.AppCache.swapCache=function(){return window.applicationCache?applicationCache.swapCache():void 0},a.AppCache.UNCACHED=0,a.AppCache.IDLE=1,a.AppCache.CHECKING=2,a.AppCache.DOWNLOADING=3,a.AppCache.UPDATEREADY=4,a.AppCache.OBSOLETE=5,a.Astar=function(b){if("number"!=typeof b)b=0;else if(0>b)throw"the epsilon parameter must be positive";this.findPath=function(c){var d,e={},f={},g={},h=new a.Heap(function(a,c){var d=f[a.id]+a.heuristic*(1+b),e=f[c.id]+c.heuristic*(1+b);return e>d?-1:d>e?1:0},function(a,b){return a.id===b.id});for(f[c.id]=0,h.push(c);!h.isEmpty();){var i=h.pop(),j=f[i.id];if(delete f[i.id],!i.heuristic){var k=[];for(d=i;g.hasOwnProperty(d.id);d=g[d.id].parent)k.push(g[d.id].edge);return k.reverse()}e[i.id]=!0;for(var l in i.neighbors)if(i.neighbors.hasOwnProperty(l)&&(d=i.neighbors[l](),!e.hasOwnProperty(d.id))){var m=j+i.distance(l);f.hasOwnProperty(d.id)?m<f[d.id]&&h.decreaseKey(d,function(a){f[a.id]=m,g[a.id]={parent:i,edge:l}}):(f[d.id]=m,g[d.id]={parent:i,edge:l},h.push(d))}}return null}},a.Audio=function(){var b=function(){return function(){try{return new Audio}catch(a){return document.createElement("audio")}}()},c=a.Polyfill.getPrefixedConstructor("AudioContext"),d=b();this.load=function(a,b,c){return new e(a,b,c)},this.canPlayType=function(a){return""!==d.canPlayType(a)};var e;if("undefined"!=typeof c){var f=new c;e=function(b,c,d){var g,h,i=this,j=0,k=0,l=!1,m=!1;return this.play=function(){if(h){g=f.createBufferSource(),g.buffer=h,g.loop=l,g.connect(f.destination);var a=h.duration-j;k=f.currentTime,g.start?g.start(0,j,a):g.noteGrainOn&&g.noteGrainOn(0,j,a)}return i},this.pause=function(){return g&&(g.stop?g.stop(0):g.nodeOff&&g.noteOff(0),g.disconnect(),j+=(f.currentTime-k)%h.duration),i},this.clone=function(){var a=new e(h);return a.setLooping(l),a},this.isLoaded=function(){return m},this.setLooping=function(a){return l=a,g&&(g.loop=a),i},"string"!=typeof b?(h=b,this):(a.Ajax.get({type:"arraybuffer",url:b,load:function(a){f.decodeAudioData(a,function(a){h=a,m=!0,"function"==typeof c&&c(i)},function(){"function"==typeof d&&d(b)})},error:function(){"function"==typeof d&&d()}}),this)}}else"undefined"!=typeof d&&(e=function(a,c,d){var f,g=this,h=!1,i=!1;return this.play=function(){return h||(document.body.appendChild(f),h=!0),f.play(),g},this.pause=function(){return f.pause(),g},this.clone=function(){var a=new e(f.cloneNode(!0));return a.setLooping(f.loop),a},this.isLoaded=function(){return i},this.setLooping=function(a){return f.loop=!!a,g},"string"!=typeof a?(f=a,i=!0):(f=b(),function(a){a("canplay"),a("canplaythrough")}(function(a){f.addEventListener(a,function b(){f.removeEventListener(a,b,!1),i||(i=!0,"function"==typeof c&&c(g))},!1)}),f.addEventListener("error",function(a){"function"==typeof d&&d(a)},!1),f.setAttribute("preload","auto"),f.setAttribute("src",a),f.load()),f.addEventListener("ended",function(){h&&!f.loop&&(document.body.removeChild(f),h=!1)},!1),this});e.prototype.playClone=function(){var a=this.clone();return a.play(),a}},a.Buckets=function(b,c){function d(){this.sections={},this.minS=0,this.maxS=0}function e(a,b){var c=a+" "+b;return l.hasOwnProperty(c)?l[c]:l[c]=new d}function f(){}function g(c,d,e,g,h){return c.frames.length?(this.element=c,this.animation=d,this.i=e,this.j=g,this.k=h,this.p=b.projectElement(this.element,this.i,this.j,this.k),this.bi=Math.floor(this.p[1]/j),this.bj=Math.floor(this.p[0]/i),this.removers=[],this.removed=!1,this.timeOffset=a.Timing.now(),this.addToBuckets(),void 0):new f}function h(a,b,d,e){if(!(a in c.tiles))throw{message:"invalid tile ID",id:a};var f=c.tiles[a],h=k.getTileAnimation(a);h.static=h.static&&!f.mutable;var i=new g(f,h,b,d,e),j=i.remove.bind(i);if(!f.mutable)return j;var l=!1;m.put(b,d,e,function(){return j(),l?!1:(m.erase(b,d,e),l=!0,!0)})}var i=b.getWidth(),j=b.getHeight(),k=new a.FrameTable(c);!function(){var a;for(a in c.tiles)c.tiles.hasOwnProperty(a)&&k.registerTile(a);for(a in c.entities)c.entities.hasOwnProperty(a)&&k.registerEntity(a)}(),d.prototype.add=function(b,c,d,e,f){return this.minS=Math.min(this.minS,b[2]),this.maxS=Math.max(this.maxS,b[2]),this.sections[b[2]]||(this.sections[b[2]]=new a.MultiSet),this.sections[b[2]].add({p:b,width:c,height:d,"static":e.static,getFrame:e,timeOffset:f})},d.prototype.prerender=function(a){for(var b in this.sections)if(this.sections.hasOwnProperty(b)){var c=[];if(this.sections[b].forEach(function(a,b){a.static&&(a.remove=b,c.push(a))}),c.length){var d=c[0],e=c.reduce(function(a,b){return Math.min(a,b.p[0])},d.p[0]),f=c.reduce(function(a,b){return Math.min(a,b.p[1])},d.p[1]),g=c.reduce(function(a,b){return Math.max(a,b.p[0]+b.width)},d.p[0]+d.width),h=c.reduce(function(a,b){return Math.max(a,b.p[1]+b.height)},d.p[0]+d.height);!function(d){d.width=g-e+1,d.height=h-f+1;var i=d.getContext("2d");c.forEach(function(b){i.drawImage(a.getImage(b.getFrame(0)),b.p[0]-e,b.p[1]-f),b.remove()}),this.sections[b].add({p:[e,f,parseInt(b,10)],width:g-e+1,height:h-f+1,"static":!0,getFrame:function(){return d},timeOffset:0})}(document.createElement("canvas"))}}},d.prototype.enumerateSection=function(a,b){this.sections.hasOwnProperty(a)&&this.sections[a].fastForEach(b)};var l={};f.prototype.updatePosition=function(){},f.prototype.remove=function(){},f.prototype.replace=function(){},g.prototype.addToBucket=function(a,b){this.removers.push(e(a,b).add(this.p,this.element.width,this.element.height,this.animation,this.timeOffset))},g.prototype.addToBuckets=function(){this.addToBucket(this.bi,this.bj);var a=Math.floor((this.p[1]+this.element.height)/j),b=Math.floor((this.p[0]+this.element.width)/i);a>this.bi&&this.addToBucket(this.bi+1,this.bj),b>this.bj&&this.addToBucket(this.bi,this.bj+1),a>this.bi&&b>this.bj&&this.addToBucket(this.bi+1,this.bj+1)},g.prototype.remove=function(){for(var a in this.removers)this.removers.hasOwnProperty(a)&&this.removers[a]();return this.removers=[],this.removed=!0},g.prototype.isRemoved=function(){return this.removed},g.prototype.getProjectedPosition=function(){return{x:this.p[0]-this.element.offset.x,y:this.p[1]-this.element.offset.y,z:this.p[2]}},g.prototype.getProjectedRectangle=function(){return{x:this.p[0],y:this.p[1],z:this.p[2],width:this.element.width,height:this.element.height}},g.prototype.updatePosition=function(a,c,d){if(!this.removed){var e=b.projectElement(this.element,this.i=a,this.j=c,this.k=d),f=Math.floor(this.p[1]/j),g=Math.floor(this.p[0]/i);e[2]!==this.p[2]||f!==this.bi||g!==this.bj?(this.remove(),this.removed=!1,this.p[0]=e[0],this.p[1]=e[1],this.p[2]=e[2],this.bi=f,this.bj=g,this.addToBuckets()):(this.p[0]=e[0],this.p[1]=e[1],this.p[2]=e[2])}},g.prototype.replace=function(a){if(!this.removed){if(!(a in c.entities))throw{message:"invalid entity ID",id:a};this.remove();var b=c.entities[a],d=k.getEntityAnimation(a);return d.static=!1,new g(b,d,this.i,this.j,this.k)}};var m=new a.Matrix;this.addTile=h,this.addEntity=function(a,b,d,e){if(!(a in c.entities))throw{message:"invalid entity ID",id:a};var f=c.entities[a],h=k.getEntityAnimation(a);return h.static=!1,new g(f,h,b,d,e)},this.removeTile=function(a,b,c){return m.has(a,b,c)?m.get(a,b,c)():!1},this.replaceTile=function(a,b,c,d){return m.has(a,b,c)?(m.get(a,b,c)(),h(d,a,b,c)):void 0},this.synchronize=k.synchronize,this.forEachElement=function(c){function d(a){if(a.p[0]<-f.x+i&&a.p[1]<-f.y+j&&a.p[0]+a.width>=-f.x&&a.p[1]+a.height>=-f.y){var b=a.getFrame(q-a.timeOffset);c(a.p[0],a.p[1],b.id,b.x,b.y,b.width,b.height)}}for(var f=b.getOrigin(),g=Math.floor(-f.y/j),h=Math.floor(-f.x/i),k=e(g,h),l=e(g,h+1),m=e(g+1,h),n=e(g+1,h+1),o=Math.min(k.minS,l.minS,m.minS,n.minS),p=Math.max(k.maxS,l.maxS,m.maxS,n.maxS),q=a.Timing.now(),r=o;p>=r;r++)k.enumerateSection(r,d),l.enumerateSection(r,d),m.enumerateSection(r,d),n.enumerateSection(r,d)},this.prerender=function(a){for(var b in l)l.hasOwnProperty(b)&&l[b].prerender(a)}},a.DebugEffect=function(a,b){function c(a,b,c,d,e,g){var h=[f.project(b,c,d),f.project(b+e,c,d),f.project(b+e,c+g,d),f.project(b,c+g,d)];a.moveTo(h[0][0],h[0][1]),a.lineTo(h[1][0],h[1][1]),a.lineTo(h[2][0],h[2][1]),a.lineTo(h[3][0],h[3][1]),a.lineTo(h[0][0],h[0][1])}function d(a,b,c){var d=f.project(b.i,b.j,b.k),e=f.project(b.i+c.i,b.j+c.j,b.k+c.k);a.moveTo(d[0],d[1]),a.lineTo(e[0],e[1])}var e=!0,f=a.getView();this.enable=function(){e=!0},this.disable=function(){e=!1},this.toggle=function(a){return e=arguments.length<1?!e:!!a},this.isEnabled=function(){return e},this.getOption=function(a){return b[a]},this.setOption=function(a,c){b[a]=c},this.isOver=function(){return!1},this.postProcess=function(g){if(e){if(g.save(),g.globalAlpha=1,g.globalCompositeOperation="source-over",g.lineWidth=1,g.lineCap="butt",g.shadowOffsetX=0,g.shadowOffsetY=0,g.shadowBlur=0,g.shadowColor="transparent",b.drawBoundingBoxes&&(g.strokeStyle=b.boundingBoxStyle||"#FF0000",g.beginPath(),a.forEachInstance(function(a){var b=a.getPosition(),d=a.getEntity().getBoundingBox();c(g,b.i+d.i0,b.j+d.j0,b.k,d.iSpan,d.jSpan)}),g.stroke()),b.drawVelocity&&(g.strokeStyle=b.velocityStyle||"#FF0000",g.beginPath(),a.forEachInstance(function(a){a.isPhysicsEnabled()&&d(g,a.getPosition(),a.getVelocity())}),g.stroke()),b.drawUniformVelocity&&(g.strokeStyle=b.uniformVelocityStyle||"#FF0000",g.beginPath(),a.forEachInstance(function(a){a.isPhysicsEnabled()&&d(g,a.getPosition(),a.getUniformVelocity())}),g.stroke()),b.drawAcceleration&&(g.strokeStyle=b.accelerationStyle||"#FF0000",g.beginPath(),a.forEachInstance(function(a){a.isPhysicsEnabled()&&d(g,a.getPosition(),a.getAcceleration())}),g.stroke()),b.drawSolidMap){var h=a.getTileMap();g.fillStyle=b.solidMapStyle||"#FF0000",g.beginPath(),h.forEachTile(function(a,b,d){f.intersects(a,b,d,1,1,1)&&!h.getTile(h.getAt(a,b,d)).isWalkable()&&c(g,a,b,d,1,1)}),g.fill()}g.restore()}}},a.FrameTable=function(a){function b(a,b){for(var c;b;)c=b,b=a%b,a=c;return a}function c(a){var c;if(a.length<2)return c=function(){return a[0]},c.static=!0,c;var d,e=0,f=0,g=!0;for(var i in a)a.hasOwnProperty(i)&&(a[i].hasOwnProperty("duration")?(e=b(e,a[i].duration),f+=a[i].duration):(g=!1,d=a[i]));var j={},k=0,l=function(c){j={},k=b(e,c);for(var d=0,g=0,h=0;f>h;h+=k,g+=k)g>a[d].duration&&(d++,g=0),j[h]=a[d]};return l(e),h.push(l),c=function(){return g?function(a){return j[Math.floor(a%f/k)*k]}:function(a){return a>=f?d:j[Math.floor(a/k)*k]}}(),c.static=!1,c}var d={},e={},f={},g=0,h=[];this.registerTile=function(b){if(!a.tiles.hasOwnProperty(b))throw"invalid tile ID: "+b;f[d[b]=g++]=new c(a.tiles[b].frames)},this.registerEntity=function(b){if(!a.entities.hasOwnProperty(b))throw"invalid entity ID: "+b;f[e[b]=g++]=new c(a.entities[b].frames)},this.getTileAnimation=function(a){return f[d[a]]},this.getEntityAnimation=function(a){return f[e[a]]},this.synchronize=function(a){for(var b in h)h.hasOwnProperty(b)&&h[b](a)}},a.Heap=function(a,b){function c(a){return 2*a+1}function d(a){return 2*a+2}function e(a){return Math.floor((a-1)/2)}function f(b,c){return a(j[b],j[c])<0}function g(a,b){var c=j[a];j[a]=j[b],j[b]=c}function h(a){var b=c(a),e=d(a),i=a;j.length>b&&f(b,a)&&(i=b),j.length>e&&f(e,i)&&(i=e),i>a&&(g(a,i),h(i))}function i(e,f,g){return f<j.length?b(e,j[f])?("function"==typeof g&&g(f),!0):a(e,j[f])<0?!1:i(e,c(f),g)||i(e,d(f),g):!1}b||(b=function(a,b){return a===b});var j=[];this.push=function(a){var b=j.length;j.push(a);for(var c=e(b);b&&f(b,c);)g(b,c),b=c,c=e(b)},this.pop=function(){var a=j[0],b=j.pop();return j.length&&(j[0]=b,h(0)),a},this.peek=function(){return j.length>0?j[0]:void 0},this.contains=function(a){return i(a,0)},this.find=function(a){var b;return i(a,0,function(a){b=j[a]})?b:void 0},this.decreaseKey=function(a,b){return i(a,0,function(a){b(j[a]);for(var c=e(a);a&&f(a,c);)g(a,c),a=c,c=e(a)})},this.count=function(){return j.length},this.isEmpty=function(){return!j.length},this.clear=function(){j=[]}},"undefined"==typeof window.KeyEvent&&(window.KeyEvent={DOM_VK_CANCEL:3,DOM_VK_HELP:6,DOM_VK_BACK_SPACE:8,DOM_VK_TAB:9,DOM_VK_CLEAR:12,DOM_VK_RETURN:13,DOM_VK_ENTER:14,DOM_VK_SHIFT:16,DOM_VK_CONTROL:17,DOM_VK_ALT:18,DOM_VK_PAUSE:19,DOM_VK_CAPS_LOCK:20,DOM_VK_KANA:21,DOM_VK_HANGUL:21,DOM_VK_EISU:22,DOM_VK_JUNJA:23,DOM_VK_FINAL:24,DOM_VK_HANJA:25,DOM_VK_KANJI:25,DOM_VK_ESCAPE:27,DOM_VK_CONVERT:28,DOM_VK_NONCONVERT:29,DOM_VK_ACCEPT:30,DOM_VK_MODECHANGE:31,DOM_VK_SPACE:32,DOM_VK_PAGE_UP:33,DOM_VK_PAGE_DOWN:34,DOM_VK_END:35,DOM_VK_HOME:36,DOM_VK_LEFT:37,DOM_VK_UP:38,DOM_VK_RIGHT:39,DOM_VK_DOWN:40,DOM_VK_SELECT:41,DOM_VK_PRINT:42,DOM_VK_EXECUTE:43,DOM_VK_PRINTSCREEN:44,DOM_VK_INSERT:45,DOM_VK_DELETE:46,DOM_VK_0:48,DOM_VK_1:49,DOM_VK_2:50,DOM_VK_3:51,DOM_VK_4:52,DOM_VK_5:53,DOM_VK_6:54,DOM_VK_7:55,DOM_VK_8:56,DOM_VK_9:57,DOM_VK_COLON:58,DOM_VK_SEMICOLON:59,DOM_VK_LESS_THAN:60,DOM_VK_EQUALS:61,DOM_VK_GREATER_THAN:62,DOM_VK_QUESTION_MARK:63,DOM_VK_AT:64,DOM_VK_A:65,DOM_VK_B:66,DOM_VK_C:67,DOM_VK_D:68,DOM_VK_E:69,DOM_VK_F:70,DOM_VK_G:71,DOM_VK_H:72,DOM_VK_I:73,DOM_VK_J:74,DOM_VK_K:75,DOM_VK_L:76,DOM_VK_M:77,DOM_VK_N:78,DOM_VK_O:79,DOM_VK_P:80,DOM_VK_Q:81,DOM_VK_R:82,DOM_VK_S:83,DOM_VK_T:84,DOM_VK_U:85,DOM_VK_V:86,DOM_VK_W:87,DOM_VK_X:88,DOM_VK_Y:89,DOM_VK_Z:90,DOM_VK_WIN:91,DOM_VK_CONTEXT_MENU:93,DOM_VK_SLEEP:95,DOM_VK_NUMPAD0:96,DOM_VK_NUMPAD1:97,DOM_VK_NUMPAD2:98,DOM_VK_NUMPAD3:99,DOM_VK_NUMPAD4:100,DOM_VK_NUMPAD5:101,DOM_VK_NUMPAD6:102,DOM_VK_NUMPAD7:103,DOM_VK_NUMPAD8:104,DOM_VK_NUMPAD9:105,DOM_VK_MULTIPLY:106,DOM_VK_ADD:107,DOM_VK_SEPARATOR:108,DOM_VK_SUBTRACT:109,DOM_VK_DECIMAL:110,DOM_VK_DIVIDE:111,DOM_VK_F1:112,DOM_VK_F2:113,DOM_VK_F3:114,DOM_VK_F4:115,DOM_VK_F5:116,DOM_VK_F6:117,DOM_VK_F7:118,DOM_VK_F8:119,DOM_VK_F9:120,DOM_VK_F10:121,DOM_VK_F11:122,DOM_VK_F12:123,DOM_VK_F13:124,DOM_VK_F14:125,DOM_VK_F15:126,DOM_VK_F16:127,DOM_VK_F17:128,DOM_VK_F18:129,DOM_VK_F19:130,DOM_VK_F20:131,DOM_VK_F21:132,DOM_VK_F22:133,DOM_VK_F23:134,DOM_VK_F24:135,DOM_VK_NUM_LOCK:144,DOM_VK_SCROLL_LOCK:145,DOM_VK_CIRCUMFLEX:160,DOM_VK_EXCLAMATION:161,DOM_VK_DOUBLE_QUOTE:162,DOM_VK_HASH:163,DOM_VK_DOLLAR:164,DOM_VK_PERCENT:165,DOM_VK_AMPERSAND:166,DOM_VK_UNDERSCORE:167,DOM_VK_OPEN_PAREN:168,DOM_VK_CLOSE_PAREN:169,DOM_VK_ASTERISK:170,DOM_VK_PLUS:171,DOM_VK_PIPE:172,DOM_VK_HYPHEN_MINUS:173,DOM_VK_OPEN_CURLY_BRACKET:174,DOM_VK_CLOSE_CURLY_BRACKET:175,DOM_VK_TILDE:176,DOM_VK_COMMA:188,DOM_VK_PERIOD:190,DOM_VK_SLASH:191,DOM_VK_BACK_QUOTE:192,DOM_VK_OPEN_BRACKET:219,DOM_VK_BACK_SLASH:220,DOM_VK_CLOSE_BRACKET:221,DOM_VK_QUOTE:222,DOM_VK_META:224,DOM_VK_ALTGR:225,DOM_KEY_LOCATION_STANDARD:0,DOM_KEY_LOCATION_LEFT:1,DOM_KEY_LOCATION_RIGHT:2,DOM_KEY_LOCATION_NUMPAD:3,DOM_KEY_LOCATION_MOBILE:4,DOM_KEY_LOCATION_JOYSTICK:5}),a.Keyboard=function(b,c){function d(){function b(b,d){return b in c||(c[b]=new a.MultiSet),c[b].add(d||function(){})}var c={};this.register=function(a,c){if("number"==typeof a)return b(a,c);var d=[];for(var e in a)a.hasOwnProperty(e)&&d.push(b(a[e],c));return function(){for(var a in d)d.hasOwnProperty(a)&&d[a]()}},this.fire=function(a){return a in c?(c[a].fastForEach(function(b){b(a)}),!0):!1}}var e={},f={},g=new d,h=new d,i=new d;c===!0||"undefined"==typeof c?(b.addEventListener("keydown",function(a){var b=a.charCode||a.keyCode;e[b]?f[b]&&a.preventDefault():(e[b]=!0,g.fire(b)&&(f[b]=!0,a.preventDefault()))},!1),b.addEventListener("keypress",function(a){i.fire(a.charCode||a.keyCode)&&a.preventDefault()},!1),b.addEventListener("keyup",function(a){var b=a.charCode||a.keyCode;delete e[b],delete f[b],h.fire(b)&&a.preventDefault()},!1)):(b.addEventListener("keydown",function(a){var b=a.charCode||a.keyCode;e[b]||(e[b]=!0,g.fire(b))},!1),b.addEventListener("keypress",function(a){i.fire(a.charCode||a.keyCode)},!1),b.addEventListener("keyup",function(a){var b=a.charCode||a.keyCode;delete e[b],h.fire(b)},!1)),this.isKeyDown=function(a){return a in e},this.areKeysDown=function(){for(var a in arguments)if(!e[arguments[a]])return!1;return!0},this.onKeyDown=g.register,this.onKeyUp=function(a,b){return"number"!=typeof a?h.register(a,function(){for(var c in a)if(a.hasOwnProperty(c)&&e[a[c]])return;return b.apply(this,arguments)}):h.register(a,b)},this.onKeyPress=i.register},a.List=function(){function a(d){return d?(this.element=function(){return d.element},this.previous=function(){if("removed"in d)throw{message:"no previous element, this element has been removed",element:d.element};return new a(d.previous)},this.next=function(){if("removed"in d)throw{message:"no next element, this element has been removed",element:d.element};return new a(d.next)},this.remove=function(){return"removed"in d?!1:(d.previous&&(d.previous.next=d.next),d.next&&(d.next.previous=d.previous),d===b&&(b=d.next),d===c&&(c=d.previous),d.removed=!0,!0)},void 0):null}var b=null,c=null,d=0;this.addHead=function(e){return b={element:e,previous:null,next:b},c||(c=b),d++,new a(b)},this.getHead=function(){return new a(b)},this.addTail=function(e){return c={element:e,previous:c,next:null},b||(b=c),d++,new a(c)},this.getTail=function(){return new a(c)},this.count=function(){return d},this.isEmpty=function(){return!d},this.clear=function(){b=null,c=null,d=0},this.forEach=function(a){for(var c=b;c;c=c.next)if(a(c.element)===!1)return!0;return!1},this.forEachReverse=function(a){for(var b=c;b;b=b.previous)if(a(b.element)===!1)return!0;return!1}},a.Loader=function(b){function c(a){return a.replace(/[\\\/]$/,"")}function d(){i((o+r)/s)}function e(){n&&q&&h(k)}function f(c){function f(a){return function(){l.hasOwnProperty(a)&&l[a].fastForEach(function(b){b.width=m[a].width,b.height=m[a].height}),p.hasOwnProperty(a)&&p[a].fastForEach(function(b){b.width=m[a].width,b.height=m[a].height}),q()}}function g(a){for(var c in a.frames)a.frames.hasOwnProperty(c)&&!function(a,c){if(a in m)c();else{var d=new Image;m[a]=d,d.addEventListener("load",c,!1),d.src=[b.imagesPath,a].join("/")}}(a.frames[c].id,f(a.frames[c].id))}if("string"!=typeof b.imagesPath)throw'Invalid value specified for "imagesPath"';var h,i,j=0,l={};for(h in c.tiles)c.tiles.hasOwnProperty(h)&&(i=c.tiles[h].frames,j+=i.length,i.length&&(l.hasOwnProperty(i[0].id)||(l[i[0].id]=new a.MultiSet),l[i[0].id].add(c.tiles[h])));var p={};for(h in c.entities)c.entities.hasOwnProperty(h)&&(i=c.entities[h].frames,j+=i.length,i.length&&(p.hasOwnProperty(i[0].id)||(p[i[0].id]=new a.MultiSet),p[i[0].id].add(c.entities[h])));var q=function(){var a=0;return function(){o=100*++a/Math.max(1,j),d(),a>=j&&(!function(a){a(c.tiles),a(c.entities)}(function(a){for(var b in a)if(a.hasOwnProperty(b))for(var c in a[b].frames)if(a[b].frames.hasOwnProperty(c)){var d=a[b].frames[c];d.hasOwnProperty("x")||(d.x=0,d.y=0,d.width=m[d.id].width,d.height=m[d.id].height)}}),n=!0,e())}}();if(0===j)return q(),k;for(h in c.tiles)c.tiles.hasOwnProperty(h)&&g(c.tiles[h]);for(h in c.entities)c.entities.hasOwnProperty(h)&&g(c.entities[h]);return k}function g(c){function f(a){return function(){j(a)}}function g(c){for(var d in c)if(c.hasOwnProperty(d))try{var e=a.Loader.getSourceInfo(c[d]);if(l.canPlayType(e.mimeType))return[b.soundsPath,e.url].join("/")}catch(f){return!1}return!1}if("string"!=typeof b.soundsPath)throw'Invalid value specified for "soundsPath"';var h=Object.keys(c).length,i=function(){var a=0;return function(){r=100*++a/Math.max(1,h),d(),a>=h&&(q=!0,e())}}();if(0===h)return i(),k;for(var m in c)if(c.hasOwnProperty(m))if(m in p)i();else{var n=g(c[m]);!1===n?(j(m),i()):p[m]=l.load(n,i,f(m))}return k}if("string"==typeof b.basePath&&(b.imagesPath=b.soundsPath=c(b.basePath)),"string"!=typeof b.imagesPath)throw'Invalid value specified for "imagesPath"';if(b.imagesPath=c(b.imagesPath),"string"!=typeof b.imagesPath)throw'Invalid value specified for "soundsPath"';if(b.soundsPath=c(b.soundsPath),"function"!=typeof b.complete)throw'Invalid callback specified for "complete"';var h=b.complete,i=b.progress||function(){},j=b.error||function(){},k=this,l=new a.Audio,m={},n=!1,o=0,p={},q=!1,r=0,s=2;this.getImage=function(a,c){if("object"!=typeof a){if(m.hasOwnProperty(a))return m[a];if("string"!=typeof b.imagesPath)throw'Invalid value specified for "imagesPath"';var d=new Image;return"function"==typeof c&&d.addEventListener("load",c,!1),d.src=[b.imagesPath,a].join("/"),m[a]=d}return a},this.getSound=function(a){return p.hasOwnProperty(a)?p[a]:null},this.loadAssets=function(a,b){return n="undefined"==typeof a||null===a,q="undefined"==typeof b||null===b,n&&q?(e(),k):(n^q&&(s=1),n||f(a),q||g(b),k)},this.loadStage=function(b,c,d){return a.Ajax.getJSON(c,function(c){var e=h;h=function(){h=e,e(k,new a.Stage(c,b))},k.loadAssets(c,d)},function(){j.apply(k,arguments)}),k}},a.Loader.guessMimeType=function(a){var b=[{pattern:/\.aac$/i,mime:"audio/aac"},{pattern:/\.mp3$/i,mime:"audio/mp3"},{pattern:/\.ogg$/i,mime:"application/ogg"}];for(var c in b)if(b.hasOwnProperty(c)&&b[c].pattern.test(a))return b[c].mime;throw"Couldn't guess the MIME type from the resource URL"},a.Loader.getSourceInfo=function(b){if("string"==typeof b)return{url:b,mimeType:a.Loader.guessMimeType(b)};if("object"!=typeof b)throw"Invalid source specified";return b.hasOwnProperty("url")&&b.hasOwnProperty("mimeType")?b:void 0},a.Loader.prototype.playSound=function(a,b){var c=this.getSound(a);return null!==c&&(c.setLooping(!!b),c.play()),c},a.Matrix=function(){this.data={},this.layers={}},a.Matrix.prototype.get=function(a,b,c){return this.data[a+" "+b+" "+c]},a.Matrix.prototype.put=function(a,b,c,d){this.data[a+" "+b+" "+c]=d,this.layers[c]=!0},a.Matrix.prototype.has=function(a,b,c){return this.data.hasOwnProperty(a+" "+b+" "+c)},a.Matrix.prototype.hasLayer=function(a){return this.layers.hasOwnProperty(a)},a.Matrix.prototype.erase=function(a,b,c){var d=a+" "+b+" "+c;return this.data.hasOwnProperty(d)?(delete this.data[d],!0):!1},a.Matrix.prototype.forEach=function(a,b){for(var c in this.data)if(this.data.hasOwnProperty(c)){var d=c.split(" ");if(a.call(b,d[0],d[1],d[2],this.data[c])===!1)return!0}return!1},a.Matrix.prototype.forEachLayer=function(a,b){for(var c in this.layers)if(this.layers.hasOwnProperty(c)&&a.call(b,parseInt(c,10))===!1)return!0;return!1},a.mobileBrowser=function(a){return/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows (ce|phone)|xda|xiino|android|ipad|playbook|silk/i.test(a)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(a.substr(0,4))}(navigator.userAgent||navigator.vendor||window.opera),a.Mouse=function(b){function c(a){return function(c){var d=b.getBoundingClientRect();a.call(b,c,c.clientX-d.left,c.clientY-d.top)}}var d,e,f=new a.MultiSet,g=new a.MultiSet,h=new a.MultiSet,i=new a.MultiSet,j=new a.MultiSet,k=!1,l=0;b.addEventListener("mousedown",c(function(a,b,c){l=a.button,k=!0,d=b,e=c,g.fastForEach(function(d){d(b,c,a.button)})}),!1),b.addEventListener("mousemove",c(function(a,b,c){f.fastForEach(function(a){a(b,c)}),k&&(i.fastForEach(function(a){a(d,e,b,c,l)}),d=b,e=c)}),!1),b.addEventListener("mouseup",c(function(a,b,c){k=!1,h.fastForEach(function(d){d(b,c,a.button)})}),!1),"undefined"!=typeof b.onwheel?b.addEventListener("wheel",c(function(a,b,c){j.fastForEach(function(d){d(b,c,-a.deltaX,-a.deltaY)})}),!1):"undefined"!=typeof b.onmousewheel&&b.addEventListener("mousewheel",c(function(a,b,c){j.fastForEach(function(d){d(b,c,a.wheelDeltaX,a.wheelDeltaY)})}),!1),this.onMove=function(a){return f.add(a)},this.onDown=function(a){return g.add(a)},this.onUp=function(a){return h.add(a)},this.onDrag=function(a){return i.add(a)
},this.onWheel=function(a){return j.add(a)}},a.ParametricStateMachine=function(a,b,c){function d(a){if("string"!=typeof a){if(!(0 in a))throw"invalid transition: "+a;var c=a;if(a=a[0],!(a in b))throw'invalid state "'+a+'"';"function"!=typeof b[a]?e=b[a]:(c.shift(),e=b[a].apply(e,c)),f=a}else{if(!(a in b))throw'invalid state "'+a+'"';e="function"!=typeof b[a]?b[a]:b[a].call(e),f=a}}var e,f;d(c),function(b){var c=function(a){b[a]=function(){if(a in e)if("function"!=typeof e[a])d(e[a]);else{var b=e[a].apply(e,arguments);"undefined"!=typeof b&&d(b)}return f}};for(var g in a)a.hasOwnProperty(g)&&c(a[g])}(this),this.getCurrentState=function(){return f}},a.Renderer=function(a,b,c,d,e,f){function g(a,c,d,e,f,g,h){j.drawImage(b.getImage(d),e,f,g,h,a,c,g,h)}if("string"==typeof a&&(a=document.querySelector(a),!a))throw"No element found matching the specified selector";var h=a.width,i=a.height,j=a.getContext("2d");this.getView=function(){return c},this.getBuckets=function(){return d},this.synchronize=d.synchronize,this.getContext=function(){return j},this.render=function(){var a=c.getOrigin();j.setTransform(1,0,0,1,a.x,a.y),j.clearRect(-a.x,-a.y,h,i),e&&e(j),d.forEachElement(g),f&&f(j)}},a.RenderLoop=function(){function b(b,e,f,g,h){function i(a,b){for(a=Math.min(a,q);a>p;)z(p/1e3),a-=p;z(a/1e3),t.update(),"function"==typeof h&&h(),x++,n.render(b)}function j(){if(!r||s){r=!0,s=!1;var b=a.Timing.now(),c=b;l=v(function d(){var e=a.Timing.now(),f=e-b,g=e-c;c=e,i(g,f),(r||!s)&&(l=v(d,u))},u)}return m}function k(){if(!r||s){r=!0,s=!1;var b=a.Timing.now(),c=b;l=setInterval(function(){var d=a.Timing.now(),e=d-b,f=d-c;c=d,i(f,e)},p)}return m}var l,m=this,n=new a.StageRenderer(b,f),o=d,p=Math.floor(1e3/o),q=5e3,r=!1,s=!1,t=e||b,u=b.getCanvas(),v=a.Polyfill.getPrefixedProperty("requestAnimationFrame"),w=a.Polyfill.getPrefixedProperty("cancelAnimationFrame");n.synchronize(p),this.getRate=function(){return o};var x=0;this.getActualRate=function(){var b=a.Timing.now();return function(){if(r&&!s){var c=a.Timing.now(),d=1e3*x/(c-b);return x=0,b=c,d}return null}}(),this.getPeriod=function(){return p},this.getMaximumPeriod=function(){return q},this.setMaximumPeriod=function(a){q=a},this.getStage=function(){return b},this.getRenderer=function(){return n};var y,z=function(){return"function"!=typeof g?function(a){t.tick(a)}:function(a){t.tick(a),g(a)}}();y="request"===c?w:"interval"===c?clearInterval:v?w:clearInterval,this.run="request"===c?j:"interval"===c?k:v?j:k,this.suspend=function(){r&&!s&&(y(l),s=!0)},this.isSuspended=function(){return r&&s},this.stop=function(){r&&(y(l),r=!1,s=!0)},this.isStopped=function(){return!r&&s}}var c="auto",d=60;return b.setLoop=function(a,b){if(!(a in{request:!0,interval:!0,auto:!0}))throw'invalid loop type; only "request", "interval" and "auto" are allowed.';c=a,"number"==typeof b&&(d=b)},b}(),a.RumbleEffect=function(b,c){"undefined"==typeof c&&(c={});var d="period"in c?~~c.period:a.RumbleEffect.defaultPeriod,e="extent"in c?~~c.extent:a.RumbleEffect.defaultExtent,f="horizontal"in c?!!c.horizontal:!0,g="vertical"in c?!!c.vertical:!0,h=1;this.preProcess=function(a){if(--b>0){h=b%d?h:-h;var c=f?h*e:0,i=g?h*e:0;a.translate(c,i)}},this.isOver=function(){return 0>=b}},a.RumbleEffect.defaultPeriod=3,a.RumbleEffect.defaultExtent=2,a.Stage=function(b,c){function d(a,b,c){for(var e in b)if(b.hasOwnProperty(e)){var f;if(e in a)f=a[e];else{if(!(e in c))return!1;f=c[e]}if("object"!=typeof b[e]){if(f!==b[e])return!1}else if("object"!=typeof f||!d(f,b[e],{}))return!1}return!0}function e(a){var c=b.entities[a=parseInt(a,10)];a in j||(j[a]=this),this.getId=function(){return a},this.getProperties=function(){return c.properties},this.isPhysicsEnabled=function(){return c.enablePhysics},this.getBoundingBox=function(){return c.box},this.forEachInstance=function(b,e){return e||(e={}),k.forEach(function(f){return a===f.getEntityId()&&d(f.getProperties(),e,c.properties)?b(f):void 0})},this.createInstance=function(b,c,d){return new f({id:a,i:b,j:c,k:d,position:{i:b,j:c,k:d},previousPosition:{i:b,j:c,k:d},velocity:{i:0,j:0,k:0},uniformVelocity:{i:0,j:0,k:0},acceleration:{i:0,j:0,k:0},properties:{}},h.addEntity(a,b,c,d))}}function f(a,c){var d,m;"number"!=typeof a?(d=null,m=a):(d=a,m=b.instances[d]);var n=b.entities[m.id],o=k.add(this);n.enablePhysics&&(o=function(a,b){return function(){return a()&&b()}}(o,l.add(this))),this.getId=function(){return d},this.getProperties=function(){return m.properties},this.getEntityId=function(){return m.id},this.getEntity=function(){return j[m.id]||new e(m.id)},this.isPhysicsEnabled=function(){return n.enablePhysics},this.getPosition=function(){return m.position},this.getProjectedPosition=c.getProjectedPosition.bind(c),this.getProjectedRectangle=c.getProjectedRectangle.bind(c),this.inRange=function(){var a=g.getWidth(),b=g.getHeight();return function(d,e){var f=c.getProjectedPosition(),h=g.getOrigin(),i=(d-a)/2,j=(e-b)/2;return f.x>=-h.x-i&&f.x<=-h.x+a+i&&f.y>=-h.y-j&&f.y<=-h.y+b+j}}(),this.getVelocity=function(){return m.velocity},this.getUniformVelocity=function(){return m.uniformVelocity},this.getFullVelocity=function(){var a={i:m.velocity.i+m.uniformVelocity.i,j:m.velocity.j+m.uniformVelocity.j,k:m.velocity.k+m.uniformVelocity.k};return function(){return a.i=m.velocity.i+m.uniformVelocity.i,a.j=m.velocity.j+m.uniformVelocity.j,a.k=m.velocity.k+m.uniformVelocity.k,a}}(),this.getAcceleration=function(){return m.acceleration},this.testTileCollision=function(a,b){return(b||i).rectangleCollision(Math.floor(m.k),m.position.i+n.box.i0,m.position.j+n.box.j0,n.box.iSpan,n.box.jSpan,m.position.i-m.previousPosition.i,m.position.j-m.previousPosition.j,a)},this.tileCollision=function(a,b){var c=(b||i).rectangleCollision(Math.floor(m.k),m.position.i+n.box.i0,m.position.j+n.box.j0,n.box.iSpan,n.box.jSpan,m.position.i-m.previousPosition.i,m.position.j-m.previousPosition.j,a);return m.position.i+=c.i,m.position.j+=c.j,c.i>0&&m.velocity.i<0?m.velocity.i=0:c.i<0&&m.velocity.i>0&&(m.velocity.i=0),c.j>0&&m.velocity.j<0?m.velocity.j=0:c.j<0&&m.velocity.j>0&&(m.velocity.j=0),c},this.collidesWithTiles=function(a,b){var c=(b||i).rectangleCollision(Math.floor(m.k),m.position.i+n.box.i0,m.position.j+n.box.j0,n.box.iSpan,n.box.jSpan,m.position.i-m.previousPosition.i,m.position.j-m.previousPosition.j,a);return m.position.i+=c.i,m.position.j+=c.j,c.i>0&&m.velocity.i<0?m.velocity.i=0:c.i<0&&m.velocity.i>0&&(m.velocity.i=0),c.j>0&&m.velocity.j<0?m.velocity.j=0:c.j<0&&m.velocity.j>0&&(m.velocity.j=0),c.i||c.j},this.rectangleCollision=function(a,b,c,d,e,f){var g={i:0,j:0};return a<m.position.i+n.box.i0?a+c>m.position.i+n.box.i0&&(b<m.position.j+n.box.j0?b+d>m.position.j+n.box.j0&&(a+c<m.position.i+n.box.i0+n.box.iSpan&&(g.i=m.position.i+n.box.i0-a-c),b+d<m.position.j+n.box.j0+n.box.jSpan&&(g.j=m.position.j+n.box.j0-b-d)):b<m.position.j+n.box.j0+n.box.jSpan&&(a+c<m.position.i+n.box.i0+n.box.iSpan&&(g.i=m.position.i+n.box.i0-a-c),b+d>m.position.j+n.box.j0+n.box.jSpan&&(g.j=m.position.j+n.box.j0-b-d))):a<m.position.i+n.box.i0+n.box.iSpan&&(b<m.position.j+n.box.j0?b+d>m.position.j+n.box.j0&&(g.i=m.position.i+n.box.i0+n.box.iSpan-a,b+d<m.position.j+n.box.j0+n.box.jSpan&&(g.j=m.position.j+n.box.j0-b-d)):b<m.position.j+n.box.j0+n.box.jSpan&&(a+c>m.position.i+n.box.i0+n.box.iSpan&&(g.i=m.position.i+n.box.i0+n.box.iSpan-a),b+d>m.position.j+n.box.j0+n.box.jSpan&&(g.j=m.position.j+n.box.j0+n.box.jSpan-b))),Math.abs(g.i)>Math.abs(m.position.i-m.previousPosition.i-e)+.001&&(g.i=0),Math.abs(g.j)>Math.abs(m.position.j-m.previousPosition.j-f)+.001&&(g.j=0),g},this.testCollision=function(a){return a.rectangleCollision(m.position.i+n.box.i0,m.position.j+n.box.j0,n.box.iSpan,n.box.jSpan,m.position.i-m.previousPosition.i,m.position.j-m.previousPosition.j)},this.collision=function(a){var b=a.rectangleCollision(m.position.i+n.box.i0,m.position.j+n.box.j0,n.box.iSpan,n.box.jSpan,m.position.i-m.previousPosition.i,m.position.j-m.previousPosition.j);return m.position.i+=b.i,m.position.j+=b.j,b.i>0&&m.velocity.i<0?m.velocity.i=0:b.i<0&&m.velocity.i>0&&(m.velocity.i=0),b.j>0&&m.velocity.j<0?m.velocity.j=0:b.j<0&&m.velocity.j>0&&(m.velocity.j=0),b},this.collidesWithInstance=function(a){var b=a.rectangleCollision(m.position.i+n.box.i0,m.position.j+n.box.j0,n.box.iSpan,n.box.jSpan,m.position.i-m.previousPosition.i,m.position.j-m.previousPosition.j);return m.position.i+=b.i,m.position.j+=b.j,b.i>0&&m.velocity.i<0?m.velocity.i=0:b.i<0&&m.velocity.i>0&&(m.velocity.i=0),b.j>0&&m.velocity.j<0?m.velocity.j=0:b.j<0&&m.velocity.j>0&&(m.velocity.j=0),b.i||b.j},this.tick=function(a){var b=.5*a*a;m.previousPosition.i=m.position.i,m.previousPosition.j=m.position.j,m.previousPosition.k=m.position.k,m.position.i+=(m.velocity.i+m.uniformVelocity.i)*a+m.acceleration.i*b,m.position.j+=(m.velocity.j+m.uniformVelocity.j)*a+m.acceleration.j*b,m.position.k+=(m.velocity.k+m.uniformVelocity.k)*a+m.acceleration.k*b,m.velocity.i+=m.acceleration.i*a,m.velocity.j+=m.acceleration.j*a,m.velocity.k+=m.acceleration.k*a},this.update=function(){c.updatePosition(m.position.i,m.position.j,m.position.k)},this.remove=function(){c.remove(),o()},this.isRemoved=c.isRemoved.bind(c),this.replaceWith=function(a){if(o())return new f(m,c.replace(m.id=a.getId()));throw"the instance cannot be replaced because it has been removed"},this.fork=function(a){var b=a?a.getId():m.id;return new f({id:b,i:m.i,j:m.j,k:m.k,position:{i:m.position.i,j:m.position.j,k:m.position.k},previousPosition:{i:m.previousPosition.i,j:m.previousPosition.j,k:m.previousPosition.k},velocity:{i:m.velocity.i,j:m.velocity.j,k:m.velocity.k},uniformVelocity:{i:m.uniformVelocity.i,j:m.uniformVelocity.j,k:m.uniformVelocity.k},acceleration:{i:m.acceleration.i,j:m.acceleration.j,k:m.acceleration.k},properties:{}},h.addEntity(b,m.position.i,m.position.j,m.position.k))}}if("string"==typeof c&&(c=document.querySelector(c),!c))throw"No element found matching the specified selector";var g=new a.View(b,c),h=new a.Buckets(g,b),i=null,j={},k=new a.MultiSet,l=new a.MultiSet;!function(){i=new a.TileMap(b,h);for(var c in b.instances)if(b.instances.hasOwnProperty(c)){var d=b.instances[c];d.position={i:d.i,j:d.j,k:d.k},d.previousPosition={i:d.i,j:d.j,k:d.k},d.velocity={i:0,j:0,k:0},d.uniformVelocity={i:0,j:0,k:0},d.acceleration={i:0,j:0,k:0},new f(parseInt(c,10),h.addEntity(d.id,d.i,d.j,d.k))}}(),this.getName=function(){return b.name},this.getProperties=function(){return b.properties},this.getCanvas=function(){return c},this.getView=function(){return g},this.getBuckets=function(){return h},this.prerender=h.prerender,this.getTileMap=function(){return i},this.forEachEntity=function(a,c){c||(c={});for(var f in b.entities)if(b.entities.hasOwnProperty(f)&&d(b.entities[f].properties,c,{})&&a(j[f]||new e(f))===!1)return!0;return!1},this.getEntities=function(a){var c=[];for(var f in b.entities)b.entities.hasOwnProperty(f)&&d(b.entities[f].properties,a||{},{})&&c.push(j[f]||new e(f));return c},this.getEntity=function(a){for(var c in b.entities)if(b.entities.hasOwnProperty(c)&&d(b.entities[c].properties,a||{},{}))return j[c]||new e(c);return null},this.forEachInstance=function(a,b){return k.forEach(function(c){return d(c.getProperties(),b||{},c.getEntity().getProperties())?a(c):void 0})},this.getInstances=function(a){var b=[];return k.forEach(function(c){d(c.getProperties(),a||{},c.getEntity().getProperties())&&b.push(c)}),b},this.getInstance=function(a){var b=null;return k.forEach(function(c){return d(c.getProperties(),a||{},c.getEntity().getProperties())?(b=c,!1):void 0}),b},this.Range=function(a,b){this.forEachInstance=function(c,e){return e||(e={}),k.forEach(function(f){return f.inRange(a,b)&&d(f.getProperties(),e,f.getEntity().getProperties())?c(f):void 0})},this.tick=function(c){l.fastForEach(function(d){d.inRange(a,b)&&d.tick(c)})},this.update=function(){l.fastForEach(function(c){c.inRange(a,b)&&c.update()})}},this.tick=function(a){l.fastForEach(function(b){b.tick(a)})},this.update=function(){l.fastForEach(function(a){a.update()})}},a.StageRenderer=function(b,c){var d=[],e=new a.Renderer(b.getCanvas(),c,b.getView(),b.getBuckets(),function(a){for(var b=0;b<d.length;b++)d[b].isOver()?d.splice(b--,1):d[b].preProcess&&d[b].preProcess(a)},function(a){for(var b=d.length-1;b>=0;b--)d[b].postProcess&&d[b].postProcess(a)});return e.addEffect=function(a){d.push(a)},e},a.StateMachine=function(a,b){function c(b){if(!(b in a))throw'invalid state "'+b+'"';d=a[b],e=b}var d,e,f=function(){var b={};for(var c in a)if(a.hasOwnProperty(c))for(var d in a[c])a[c].hasOwnProperty(d)&&(b[d]=!0);return b}();c(b),function(a){var b=function(a){return function(){if(a in d){if("string"==typeof d[a]){var b=d[a];return c(b),b}if("function"==typeof d[a]){var f=d[a].apply(d,arguments);return"string"==typeof f?(c(f),f):e}throw'invalid transition "'+a+'" for state "'+e+'"'}return e}};for(var g in f)f.hasOwnProperty(g)&&(a[g]=b(g))}(this),this.getCurrentState=function(){return e}},a.TileMap=function(b,c){function d(a){var c=b.tiles[a];this.getLayout=function(){return{iSpan:c.layout.span.i,jSpan:c.layout.span.j,i0:c.layout.ref.i,j0:c.layout.ref.j}},this.isSolid=function(){return c.solid},this.getProperties=function(){return c.properties}}function e(a,b){for(var c in b)if(b.hasOwnProperty(c)){var d;if(!(c in a))return!1;if(d=a[c],"object"!=typeof b[c]){if(d!==b[c])return!1}else if("object"!=typeof d||!e(d,b[c]))return!1}return!0}function f(a){var c=[];for(var d in b.tiles)b.tiles.hasOwnProperty(d)&&e(b.tiles[d].properties,a)&&c.push(parseInt(d,10));return c}function g(a){for(var c in b.tiles)if(b.tiles.hasOwnProperty(c)&&e(b.tiles[c].properties,a))return parseInt(c,10)}var h=this,i=new a.Matrix;!function(){for(var a in b.map)if(b.map.hasOwnProperty(a)){a=parseInt(a,10);for(var d in b.map[a])if(b.map[a].hasOwnProperty(d)){d=parseInt(d,10);for(var e in b.map[a][d])if(b.map[a][d].hasOwnProperty(e)){e=parseInt(e,10);for(var f=parseInt(b.map[a][d][e],10),g=b.tiles[f].layout,h=d-g.ref.i;h<d-g.ref.i+g.span.i;h++)for(var j=e-g.ref.j;j<e-g.ref.j+g.span.j;j++)i.put(h,j,a,d+" "+e+" "+a);i.put(d,e,a,f),c.addTile(f,d,e,a)}}}delete b.map}();var j={};this.forEachLayer=function(a,b){return i.forEachLayer(a,b)},this.forEachTile=function(a,b){return i.forEach(function(c,d,e,f){return"number"==typeof f?a.call(b,c,d,e,f):void 0})},this.forEachTileInLayer=function(a,b,c){return i.forEach(function(d,e,f,g){return f==a&&"number"==typeof g?b.call(c,d,e,g):void 0})},this.getTileIds=f,this.getTileId=g,this.getTile=function(a){var c;if("object"!=typeof a){if(c=a,c in b.tiles)return j[c]||(j[c]=new d(c));throw"invalid tile id: "+c}return c=g(a),j[c]||(j[c]=new d(c))},this.getTiles=function(a){var b=f(a),c=[];for(var e in b)b.hasOwnProperty(e)&&c.push(j[b[e]]||(j[b[e]]=new d(b[e])));return c},this.getAt=function(a,b,c){var d=i.get(a,b,c);return"number"==typeof d?d:!1},this.getAt2=function(a,b,c,d){var e=i.get(a,b,c);if("undefined"==typeof e)return!1;if("number"!=typeof e){var f=(""+e).split(" "),g=i.get(f[0],f[1],c);return d?g:{id:g,i:f[0],j:f[1]}}return e},this.putAt=function(a,d,e,f){function g(a,c){var d=i.get(a,c,e);if("number"!=typeof d){var f=d.split(" ");d=i.get(f[0],f[1],e)}return b.tiles[d].mutable}function h(a,b){var d=i.get(a,b,e);if("number"!=typeof d){var f=d.split(" ");a=f[0],b=f[1]}return c.removeTile(a,b,e)?(i.erase(a,b,e),!0):!1}if(!(f in b.tiles))throw{message:"invalid tile ID",id:f};f=parseInt(f,10);var j,k,l=b.tiles[f].layout;for(j=a-l.ref.i;j<a-l.ref.i+l.span.i;j++)for(k=d-l.ref.j;k<d-l.ref.j+l.span.j;k++)if(!g(j,k,e))return!1;for(j=a-l.ref.i;j<a-l.ref.i+l.span.i;j++)for(k=d-l.ref.j;k<d-l.ref.j+l.span.j;k++){if(!h(j,k,e))return!1;i.put(j,k,e,a+" "+d)}return i.put(a,d,e,f),c.addTile(f,a,d,e),!0},this.findPath=function(){var b;return function(c,d,e,f,g){b||(b=new a.Astar);var i=b.findPath(h.getGraphNode(c,d,e,f,g));return null===i?null:a.TileMap.translatePath(c,d,i)}}(),this.getGraphNode=function(a,c,d,e,f){return function g(a,c){function h(a,b){return function(){return g(a,b)}}var j=Math.abs(e-a),k=Math.abs(f-c),l={id:a+" "+c+" "+d,heuristic:Math.sqrt(2*Math.pow(Math.min(j,k),2))+Math.max(j,k)-Math.min(j,k),neighbors:{},distance:function(a){return parseInt(a,10)%2?1:Math.sqrt(2)}};return function(){function e(a,c){if(i.has(a,c,d)){var e=i.get(a,c,d);if("number"!=typeof e){var f=e.split(" ");e=i.get(f[0],f[1],d)}return!b.tiles[e].solid}return!1}for(var f=0;9>f;f++){var g=a+[-1,-1,-1,0,0,0,1,1,1][f],j=c+[-1,0,1,-1,0,1,-1,0,1][f];g===a&&j===c||!e(g,j)||(f%2||e(a,j)&&e(g,c))&&(l.neighbors[f]=h(g,j))}}(),l}(a,c)},this.rectangleCollision=function(a,c,d,e,f,g,h,j){var k=0,l=0,m=0,n=0;if(i.hasLayer(a)){for(var o=b.tiles,p=function(){return"function"!=typeof j?function(c,d){if(i.has(c,d,a)){var e=i.get(c,d,a);if("number"!=typeof e){var f=e.split(" ");e=i.get(f[0],f[1],a)}return b.tiles[e].solid}return!1}:function(b,c){if(!i.has(b,c,a))return!1;var d=i.get(b,c,a);if("number"!=typeof d){var e=d.split(" ");d=i.get(e[0],e[1],a)}var f=o[d];return j(f.solid,f.properties)}}(),q=Math.floor(c),r=Math.floor(d),s=Math.ceil(c+e)-1,t=Math.ceil(d+f)-1,u=r;t>=u;u++)p(q,u)&&(q!==s&&p(q+1,u)||(k=q+1-c)),p(s,u)&&(q!==s&&p(s-1,u)||(l=s-c-e));for(var v=q;s>=v;v++)p(v,r)&&(r!==t&&p(v,r+1)||(m=r+1-d)),p(v,t)&&(r!==t&&p(v,t-1)||(n=t-d-f))}var w={};return w.i=k&&l?0:k?k:l,w.j=m&&n?0:m?m:n,Math.abs(w.i)>Math.abs(g)+.001&&(w.i=0),Math.abs(w.j)>Math.abs(h)+.001&&(w.j=0),w}},a.TileMap.translatePath=function(a,b,c){for(var d=[],e=0;e<c.length;++e)a+=[-1,-1,-1,0,0,0,1,1,1][c[e]],b+=[-1,0,1,-1,0,1,-1,0,1][c[e]],d.push({i:a,j:b});return d},a.Timing={now:function(){if(window.performance){var b=a.Polyfill.getPrefixedProperty(window.performance,"now");if(b)return function(){return b.call(window.performance)}}return function(){return Date.now()}}()},a.View=function(b,c){var d=b.matrix,e=function(){var a=d[0][0]*d[1][1]*d[2][2]+d[0][1]*d[1][2]*d[2][0]+d[0][2]*d[1][0]*d[2][1]-d[0][2]*d[1][1]*d[2][0]-d[0][1]*d[1][0]*d[2][2]-d[0][0]*d[1][2]*d[2][1];return[[(d[1][1]*d[2][2]-d[2][1]*d[1][2])/a,(d[0][2]*d[2][1]-d[2][2]*d[0][1])/a,(d[0][1]*d[1][2]-d[1][1]*d[0][2])/a],[(d[1][2]*d[2][0]-d[2][2]*d[1][0])/a,(d[0][0]*d[2][2]-d[2][0]*d[0][2])/a,(d[0][2]*d[1][0]-d[1][2]*d[0][0])/a],[(d[1][0]*d[2][1]-d[2][0]*d[1][1])/a,(d[0][1]*d[2][0]-d[2][1]*d[0][0])/a,(d[0][0]*d[1][1]-d[1][0]*d[0][1])/a]]}(),f=b.x0,g=b.y0,h=c.width,i=c.height;this.project=function(a,b,c){return[d[0][0]*a+d[0][1]*b+d[0][2]*c,d[1][0]*a+d[1][1]*b+d[1][2]*c,Math.round(d[2][0]*a+d[2][1]*b+d[2][2]*c)]},this.projectElement=function(a,b,c,e){return[Math.round(d[0][0]*b+d[0][1]*c+d[0][2]*e+a.offset.x),Math.round(d[1][0]*b+d[1][1]*c+d[1][2]*e+a.offset.y),Math.round(d[2][0]*b+d[2][1]*c+d[2][2]*e)]},this.unproject=function(a,b,c){var d=(c+e[2][0]*(f-a)+e[2][1]*(g-b))/e[2][2],h=e[0][0]*(a-f)+e[0][1]*(b-g)+e[0][2]*d,i=e[1][0]*(a-f)+e[1][1]*(b-g)+e[1][2]*d;return[h,i,c]},this.getCell=function(a,b,c){var d=(c-e[2][0]*(a-f)-e[2][1]*(b-g))/e[2][2],h=Math.floor(e[0][0]*(a-f)+e[0][1]*(b-g)+e[0][2]*d),i=Math.floor(e[1][0]*(a-f)+e[1][1]*(b-g)+e[1][2]*d);return{i:h,j:i,k:c}},this.getOrigin=function(){var a={x:f,y:g};return function(){return a.x=f,a.y=g,a}}(),this.getWidth=function(){return h},this.getHeight=function(){return i};var j=new a.MultiSet;this.drag=function(a,b){f+=a,g+=b,j.fastForEach(function(a){a(f,g)})},this.dragTo=function(a,b){f=a,g=b,j.fastForEach(function(a){a(f,g)})},this.onDrag=function(a){return j.add(a)},this.intersects=function(a,b,c,e,j,k){var l=d[0][0]*a+d[0][1]*b+d[0][2]*c,m=d[1][0]*a+d[1][1]*b+d[1][2]*c,n=d[0][0]*(a+e)+d[0][1]*(b+j)+d[0][2]*(c+k),o=d[1][0]*(a+e)+d[1][1]*(b+j)+d[1][2]*(c+k);return Math.min(l,n)<h-f&&Math.max(l,n)>-f&&Math.min(m,o)<i-g&&Math.max(m,o)>-g},this.Synchronizer=function(a,b,c){this.tick=function(d){var e=f,k=g,l=(h-a)/2,m=(i-b)/2,n=d.getProjectedRectangle();f+n.x+n.width>h-l&&(e=h-n.x-n.width-l),f+n.x<l&&(e=l-n.x),g+n.y+n.height>i-m&&(k=i-n.y-n.height-m),g+n.y<m&&(k=m-n.y),f+=(e-f)*(1-c),g+=(k-g)*(1-c),j.fastForEach(function(a){a(f,g)})}}},a.Visibility=new function(){var a,b;"hidden"in document?(a="hidden",b="visibilitychange"):"webkitHidden"in document?(a="webkitHidden",b="webkitvisibilitychange"):"mozHidden"in document?(a="mozHidden",b="mozvisibilitychange"):"msHidden"in document&&(a="msHidden",b="msvisibilitychange"),this.isSupported=function(){return"undefined"!=typeof a},this.isVisible=function(){return this.isSupported()?!document[a]:!0},this.onChange=function(c){return c?function(c){function d(){c(document[a])}return document.addEventListener(b,d,!1),function(){document.removeEventListener(b,d,!1)}}:function(){return function(){}}}(this.isSupported())},a.onVisibilityChange=function(b){return a.Visibility.isSupported()?a.Visibility.onChange(b):!1},a}();